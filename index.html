<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Analysis Dashboard</title>
    <meta http-equiv="refresh" content="300">
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #0a0a0a;
            --border: #1a1a1a;
            --text-primary: #e5e5e5;
            --text-secondary: #999;
            --text-tertiary: #666;
            --accent: #fff;
            --positive: #4a7c59;
            --negative: #7c4a4a;
            --neutral: #7c7c4a;
        }

        [data-theme="day"] {
            --bg-primary: #fafafa;
            --bg-secondary: #fff;
            --border: #e5e5e5;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --text-tertiary: #999;
            --accent: #000;
            --positive: #16a34a;
            --negative: #dc2626;
            --neutral: #ea580c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 40px 20px;
            line-height: 1.6;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 60px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-content {
            flex: 1;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .theme-toggle, .refresh-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .theme-toggle:hover, .refresh-btn:hover {
            color: var(--text-primary);
            border-color: var(--text-tertiary);
        }

        h1 {
            font-size: 2.5em;
            font-weight: 300;
            margin-bottom: 10px;
            letter-spacing: -0.02em;
            color: var(--text-primary);
        }

        .price {
            font-size: 3.5em;
            font-weight: 200;
            margin: 20px 0;
            letter-spacing: -0.03em;
            color: var(--text-primary);
        }

        .meta {
            color: var(--text-tertiary);
            font-size: 0.9em;
            margin-top: 10px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1px;
            background: var(--border);
            margin-bottom: 1px;
        }

        .card {
            background: var(--bg-secondary);
            padding: 30px;
            transition: background 0.3s ease;
        }

        .card-title {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-tertiary);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .metric-value {
            font-variant-numeric: tabular-nums;
            color: var(--text-primary);
        }

        .positive { color: var(--positive); }
        .negative { color: var(--negative); }
        .neutral { color: var(--neutral); }

        .section {
            margin: 60px 0;
        }

        .section-title {
            font-size: 1.5em;
            font-weight: 300;
            margin-bottom: 30px;
            letter-spacing: -0.01em;
            color: var(--text-primary);
        }

        .levels {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
        }

        .level {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 1px solid var(--border);
            transition: background 0.3s ease;
        }

        .level:last-child {
            border-bottom: none;
        }

        .level.current {
            background: var(--bg-primary);
            border-left: 2px solid var(--accent);
        }

        .level-price {
            font-size: 1.1em;
            font-variant-numeric: tabular-nums;
            color: var(--text-primary);
        }

        .level-label {
            color: var(--text-tertiary);
            font-size: 0.85em;
        }

        .level-distance {
            color: var(--text-secondary);
            font-size: 0.9em;
            font-variant-numeric: tabular-nums;
        }

        .chart-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 0;
            margin-bottom: 1px;
            transition: background 0.3s ease;
        }

        .signals {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: var(--border);
            border: 1px solid var(--border);
        }

        .signal-section {
            background: var(--bg-secondary);
            padding: 30px;
            transition: background 0.3s ease;
        }

        .signal-title {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-tertiary);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .signal-list {
            list-style: none;
        }

        .signal-list li {
            padding: 8px 0;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .signal-list li:before {
            content: "—";
            margin-right: 10px;
            color: var(--text-tertiary);
        }

        .scenarios {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: var(--border);
            border: 1px solid var(--border);
        }

        .scenario {
            background: var(--bg-secondary);
            padding: 30px;
            transition: background 0.3s ease;
        }

        .scenario-header {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-tertiary);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .scenario-trigger {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .target {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 0.95em;
            color: var(--text-primary);
        }

        .probability {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .prob-bar {
            height: 2px;
            background: var(--border);
            margin-top: 10px;
            position: relative;
        }

        .prob-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.5s ease;
        }

        .prob-value {
            font-variant-numeric: tabular-nums;
            color: var(--text-secondary);
        }

        .summary {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 40px;
            text-align: center;
            transition: background 0.3s ease;
        }

        .summary-title {
            font-size: 1.2em;
            font-weight: 300;
            margin-bottom: 30px;
            color: var(--text-primary);
        }

        .bias-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            max-width: 800px;
            margin: 0 auto;
        }

        .bias-item {
            padding: 20px;
            border: 1px solid var(--border);
            transition: border-color 0.3s ease;
        }

        .bias-label {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-tertiary);
            margin-bottom: 10px;
        }

        .bias-value {
            font-size: 1.1em;
            color: var(--text-primary);
        }

        .watch-levels {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.95em;
        }

        .card-timestamp {
            font-size: 0.7em;
            color: var(--text-tertiary);
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            text-align: right;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .signals {
                grid-template-columns: 1fr;
            }
            .scenarios {
                grid-template-columns: 1fr;
            }
            .bias-grid {
                grid-template-columns: 1fr;
            }
            .price {
                font-size: 2.5em;
            }
            h1 {
                font-size: 2em;
            }
            .header {
                flex-direction: column;
                gap: 20px;
            }
            .controls {
                width: 100%;
                flex-direction: column;
            }
            .theme-toggle, .refresh-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <h1>Bitcoin Analysis</h1>
                <div class="price" id="livePrice">Loading...</div>
                <div class="meta" id="lastUpdate">Connecting to Binance...</div>
            </div>
            <div class="controls">
                <button class="refresh-btn" onclick="location.reload()">⟳ Refresh</button>
                <button class="theme-toggle" onclick="toggleTheme()">Day Mode</button>
            </div>
        </div>

        <!-- Main Metrics -->
        <div class="grid">
            <div class="card">
                <div class="card-title">Price Action</div>
                <div class="metric-row">
                    <span class="metric-label">Spot</span>
                    <span class="metric-value" id="spotPrice">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">24h High</span>
                    <span class="metric-value" id="high24h">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">24h Low</span>
                    <span class="metric-value" id="low24h">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">24h Change</span>
                    <span class="metric-value" id="change24h">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">24h Volume</span>
                    <span class="metric-value" id="volume24h">—</span>
                </div>
                <div class="card-timestamp" id="tsPrice">—</div>
            </div>

            <div class="card">
                <div class="card-title">VWAP (15m)</div>
                <div class="metric-row">
                    <span class="metric-label">VWAP</span>
                    <span class="metric-value" id="vwapValue">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Distance</span>
                    <span class="metric-value" id="vwapDistance">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Position</span>
                    <span class="metric-value" id="vwapPosition">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Upper Band (1σ)</span>
                    <span class="metric-value" id="vwapUpper">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Lower Band (1σ)</span>
                    <span class="metric-value" id="vwapLower">—</span>
                </div>
                <div class="card-timestamp" id="tsVwap">—</div>
            </div>

            <div class="card">
                <div class="card-title">Order Book</div>
                <div class="metric-row">
                    <span class="metric-label">Spread</span>
                    <span class="metric-value" id="obSpread">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Total Bids</span>
                    <span class="metric-value" id="obBids">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Total Asks</span>
                    <span class="metric-value" id="obAsks">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Bid/Ask Ratio</span>
                    <span class="metric-value" id="obRatio">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Pressure</span>
                    <span class="metric-value" id="obPressure">—</span>
                </div>
                <div class="card-timestamp" id="tsOrderBook">—</div>
            </div>

            <div class="card">
                <div class="card-title">Futures</div>
                <div class="metric-row">
                    <span class="metric-label">Funding Rate</span>
                    <span class="metric-value" id="fundingRate">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Annualized</span>
                    <span class="metric-value" id="fundingAnnualized">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Sentiment</span>
                    <span class="metric-value" id="fundingSentiment">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Open Interest</span>
                    <span class="metric-value" id="openInterest">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">OI Change 24h</span>
                    <span class="metric-value" id="oiChange">—</span>
                </div>
                <div class="card-timestamp" id="tsFutures">—</div>
            </div>

            <div class="card">
                <div class="card-title">Spot vs Futures</div>
                <div class="metric-row">
                    <span class="metric-label">Spot Volume</span>
                    <span class="metric-value" id="spotVolume">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Futures Volume</span>
                    <span class="metric-value" id="futuresVolume">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Ratio</span>
                    <span class="metric-value" id="sfRatio">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Dominance</span>
                    <span class="metric-value" id="sfDominance">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Price Gap</span>
                    <span class="metric-value" id="sfPriceGap">—</span>
                </div>
                <div class="card-timestamp" id="tsSpotFutures">—</div>
            </div>

            <div class="card">
                <div class="card-title">Price-OI Analysis</div>
                <div class="metric-row">
                    <span class="metric-label">Status</span>
                    <span class="metric-value" id="poiStatus">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Risk Level</span>
                    <span class="metric-value" id="poiRisk">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Price Change (1h)</span>
                    <span class="metric-value" id="poiPriceChange">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Long/Short Ratio</span>
                    <span class="metric-value" id="longShortRatio">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Divergences</span>
                    <span class="metric-value" id="poiDivergence">—</span>
                </div>
                <div class="card-timestamp" id="tsPriceOI">—</div>
            </div>
        </div>

        <!-- Price Chart -->
        <div class="section">
            <div class="section-title">Price Chart & Key Levels</div>
            
            <div class="chart-container">
                <div class="tradingview-widget-container" style="height: 500px;">
                    <div id="tradingview_chart" style="height: 100%;"></div>
                </div>
            </div>
            
            <div class="levels" id="priceLevels">
                <!-- Price levels will be dynamically populated -->
                <div class="level">
                    <div>
                        <div class="level-price">Loading...</div>
                        <div class="level-label">Fetching levels...</div>
                    </div>
                    <div class="level-distance">—</div>
                </div>
            </div>
        </div>

        <!-- Signals -->
        <div class="section">
            <div class="section-title">Market Signals</div>
            <div class="signals">
                <div class="signal-section">
                    <div class="signal-title">Bullish</div>
                    <ul class="signal-list" id="bullishSignals">
                        <li>Loading signals...</li>
                    </ul>
                </div>
                <div class="signal-section">
                    <div class="signal-title">Bearish / Neutral</div>
                    <ul class="signal-list" id="bearishSignals">
                        <li>Loading signals...</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Scenarios -->
        <div class="section">
            <div class="section-title">Trading Scenarios</div>
            <div class="scenarios">
                <div class="scenario">
                    <div class="scenario-header">Bullish</div>
                    <div class="scenario-trigger" id="bullishTrigger">Loading...</div>
                    <div class="target">
                        <span>Target 1</span>
                        <span id="bullishT1">—</span>
                    </div>
                    <div class="target">
                        <span>Target 2</span>
                        <span id="bullishT2">—</span>
                    </div>
                    <div class="probability">
                        <span class="prob-value" id="bullishProb">—</span>
                        <div class="prob-bar">
                            <div class="prob-fill" id="bullishBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="scenario">
                    <div class="scenario-header">Neutral</div>
                    <div class="scenario-trigger" id="neutralTrigger">Loading...</div>
                    <div class="target">
                        <span>Range High</span>
                        <span id="neutralHigh">—</span>
                    </div>
                    <div class="target">
                        <span>Range Low</span>
                        <span id="neutralLow">—</span>
                    </div>
                    <div class="probability">
                        <span class="prob-value" id="neutralProb">—</span>
                        <div class="prob-bar">
                            <div class="prob-fill" id="neutralBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="scenario">
                    <div class="scenario-header">Bearish</div>
                    <div class="scenario-trigger" id="bearishTrigger">Loading...</div>
                    <div class="target">
                        <span>Target 1</span>
                        <span id="bearishT1">—</span>
                    </div>
                    <div class="target">
                        <span>Target 2</span>
                        <span id="bearishT2">—</span>
                    </div>
                    <div class="probability">
                        <span class="prob-value" id="bearishProb">—</span>
                        <div class="prob-bar">
                            <div class="prob-fill" id="bearishBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary -->
        <div class="section">
            <div class="summary">
                <div class="summary-title">Trading Bias</div>
                <div class="bias-grid">
                    <div class="bias-item">
                        <div class="bias-label">Short-term</div>
                        <div class="bias-value" id="biasShortTerm">—</div>
                    </div>
                    <div class="bias-item">
                        <div class="bias-label">Medium-term</div>
                        <div class="bias-value" id="biasMediumTerm">—</div>
                    </div>
                    <div class="bias-item">
                        <div class="bias-label">Conviction</div>
                        <div class="bias-value" id="biasConviction">—</div>
                    </div>
                </div>
                <div class="watch-levels" id="watchLevels">
                    Loading key levels...
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    
    <script>
        let currentTheme = localStorage.getItem('theme') || 'night';

        // Global state for all market data
        let marketData = {
            currentPrice: 0,
            high24h: 0,
            low24h: 0,
            change24h: 0,
            volume24h: 0,
            vwap: 0,
            vwapUpper: 0,
            vwapLower: 0,
            fundingRate: 0,
            openInterest: 0,
            oiChange: 0,
            bidTotal: 0,
            askTotal: 0,
            spread: 0,
            spotVolume: 0,
            futuresVolume: 0,
            longShortRatio: 1,
            weeklyOpen: 0,
            monthlyOpen: 0,
            dailyHigh: 0,
            dailyLow: 0
        };

        // Format currency
        function formatPrice(price, decimals = 2) {
            return '$' + parseFloat(price).toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        // Format large numbers
        function formatLargeNumber(num) {
            if (num >= 1e9) return '$' + (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return '$' + (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return '$' + (num / 1e3).toFixed(0) + 'K';
            return '$' + num.toFixed(0);
        }

        // Format timestamp for cards
        function formatTimestamp() {
            const now = new Date();
            return now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        // Update timestamp for a specific element
        function updateTimestamp(elementId) {
            const el = document.getElementById(elementId);
            if (el) {
                el.textContent = 'Updated: ' + formatTimestamp();
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            const button = document.querySelector('.theme-toggle');

            if (currentTheme === 'day') {
                html.removeAttribute('data-theme');
                button.textContent = 'Day Mode';
                currentTheme = 'night';
            } else {
                html.setAttribute('data-theme', 'day');
                button.textContent = 'Night Mode';
                currentTheme = 'day';
            }

            localStorage.setItem('theme', currentTheme);
            initTradingView();
        }

        // Fetch spot ticker data
        async function fetchSpotTicker() {
            try {
                const response = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT');
                const data = await response.json();

                marketData.currentPrice = parseFloat(data.lastPrice);
                marketData.high24h = parseFloat(data.highPrice);
                marketData.low24h = parseFloat(data.lowPrice);
                marketData.change24h = parseFloat(data.priceChangePercent);
                marketData.volume24h = parseFloat(data.volume);
                marketData.spotVolume = parseFloat(data.quoteVolume);

                updatePriceDisplay();
                updateTimestamp('tsPrice');
            } catch (error) {
                console.error('Failed to fetch spot ticker:', error);
            }
        }

        // Fetch order book depth
        async function fetchOrderBook() {
            try {
                const response = await fetch('https://api.binance.com/api/v3/depth?symbol=BTCUSDT&limit=100');
                const data = await response.json();

                let bidTotal = 0;
                let askTotal = 0;

                data.bids.forEach(bid => {
                    bidTotal += parseFloat(bid[0]) * parseFloat(bid[1]);
                });

                data.asks.forEach(ask => {
                    askTotal += parseFloat(ask[0]) * parseFloat(ask[1]);
                });

                const bestBid = parseFloat(data.bids[0][0]);
                const bestAsk = parseFloat(data.asks[0][0]);

                marketData.bidTotal = bidTotal;
                marketData.askTotal = askTotal;
                marketData.spread = bestAsk - bestBid;

                updateOrderBookDisplay();
                updateTimestamp('tsOrderBook');
            } catch (error) {
                console.error('Failed to fetch order book:', error);
            }
        }

        // Fetch futures funding rate
        async function fetchFundingRate() {
            try {
                const response = await fetch('https://fapi.binance.com/fapi/v1/fundingRate?symbol=BTCUSDT&limit=1');
                const data = await response.json();

                if (data && data.length > 0) {
                    marketData.fundingRate = parseFloat(data[0].fundingRate) * 100;
                }

                updateFuturesDisplay();
                updateTimestamp('tsFutures');
            } catch (error) {
                console.error('Failed to fetch funding rate:', error);
            }
        }

        // Fetch open interest
        async function fetchOpenInterest() {
            try {
                const response = await fetch('https://fapi.binance.com/fapi/v1/openInterest?symbol=BTCUSDT');
                const data = await response.json();

                marketData.openInterest = parseFloat(data.openInterest) * marketData.currentPrice;

                updateFuturesDisplay();
            } catch (error) {
                console.error('Failed to fetch open interest:', error);
            }
        }

        // Fetch futures 24hr ticker for volume comparison
        async function fetchFuturesTicker() {
            try {
                const response = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=BTCUSDT');
                const data = await response.json();

                marketData.futuresVolume = parseFloat(data.quoteVolume);

                updateSpotFuturesDisplay();
                updateTimestamp('tsSpotFutures');
            } catch (error) {
                console.error('Failed to fetch futures ticker:', error);
            }
        }

        // Fetch long/short ratio
        async function fetchLongShortRatio() {
            try {
                const response = await fetch('https://fapi.binance.com/futures/data/globalLongShortAccountRatio?symbol=BTCUSDT&period=1h&limit=1');
                const data = await response.json();

                if (data && data.length > 0) {
                    marketData.longShortRatio = parseFloat(data[0].longShortRatio);
                }

                updatePriceOIDisplay();
                updateTimestamp('tsPriceOI');
            } catch (error) {
                console.error('Failed to fetch long/short ratio:', error);
            }
        }

        // Fetch klines and calculate VWAP
        async function fetchVWAP() {
            try {
                const response = await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=15m&limit=96');
                const klines = await response.json();

                let cumulativeTPV = 0;
                let cumulativeVolume = 0;
                let squaredDiffs = 0;

                klines.forEach(kline => {
                    const high = parseFloat(kline[2]);
                    const low = parseFloat(kline[3]);
                    const close = parseFloat(kline[4]);
                    const volume = parseFloat(kline[5]);

                    const typicalPrice = (high + low + close) / 3;
                    cumulativeTPV += typicalPrice * volume;
                    cumulativeVolume += volume;
                });

                const vwap = cumulativeTPV / cumulativeVolume;

                // Calculate standard deviation for bands
                klines.forEach(kline => {
                    const high = parseFloat(kline[2]);
                    const low = parseFloat(kline[3]);
                    const close = parseFloat(kline[4]);
                    const volume = parseFloat(kline[5]);

                    const typicalPrice = (high + low + close) / 3;
                    squaredDiffs += volume * Math.pow(typicalPrice - vwap, 2);
                });

                const stdDev = Math.sqrt(squaredDiffs / cumulativeVolume);

                marketData.vwap = vwap;
                marketData.vwapUpper = vwap + stdDev;
                marketData.vwapLower = vwap - stdDev;

                updateVWAPDisplay();
                updateTimestamp('tsVwap');
            } catch (error) {
                console.error('Failed to calculate VWAP:', error);
            }
        }

        // Fetch historical data for key levels
        async function fetchKeyLevels() {
            try {
                // Fetch daily klines for monthly/weekly opens
                const dailyResponse = await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1d&limit=30');
                const dailyKlines = await dailyResponse.json();

                // Weekly open (7 days ago open)
                if (dailyKlines.length >= 7) {
                    marketData.weeklyOpen = parseFloat(dailyKlines[dailyKlines.length - 7][1]);
                }

                // Monthly open (30 days ago or first available)
                marketData.monthlyOpen = parseFloat(dailyKlines[0][1]);

                // Today's high/low
                if (dailyKlines.length > 0) {
                    const today = dailyKlines[dailyKlines.length - 1];
                    marketData.dailyHigh = parseFloat(today[2]);
                    marketData.dailyLow = parseFloat(today[3]);
                }

                updatePriceLevels();
            } catch (error) {
                console.error('Failed to fetch key levels:', error);
            }
        }

        // Update price display
        function updatePriceDisplay() {
            document.getElementById('livePrice').textContent = formatPrice(marketData.currentPrice);
            document.getElementById('spotPrice').textContent = formatPrice(marketData.currentPrice);
            document.getElementById('high24h').textContent = formatPrice(marketData.high24h);
            document.getElementById('low24h').textContent = formatPrice(marketData.low24h);

            const changeEl = document.getElementById('change24h');
            const change = marketData.change24h;
            changeEl.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
            changeEl.className = 'metric-value ' + (change >= 0 ? 'positive' : 'negative');

            document.getElementById('volume24h').textContent = marketData.volume24h.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }) + ' BTC';

            const now = new Date();
            document.getElementById('lastUpdate').textContent =
                'Last update: ' + now.toISOString().replace('T', ' ').substring(0, 19) + ' UTC • Auto-refresh: 5min';
        }

        // Update VWAP display
        function updateVWAPDisplay() {
            document.getElementById('vwapValue').textContent = formatPrice(marketData.vwap);
            document.getElementById('vwapUpper').textContent = formatPrice(marketData.vwapUpper);
            document.getElementById('vwapLower').textContent = formatPrice(marketData.vwapLower);

            const distance = ((marketData.currentPrice - marketData.vwap) / marketData.vwap * 100);
            const distanceEl = document.getElementById('vwapDistance');
            distanceEl.textContent = (distance >= 0 ? '+' : '') + distance.toFixed(2) + '%';
            distanceEl.className = 'metric-value ' + (distance >= 0 ? 'positive' : 'negative');

            const positionEl = document.getElementById('vwapPosition');
            if (marketData.currentPrice > marketData.vwapUpper) {
                positionEl.textContent = 'Above Upper Band';
                positionEl.className = 'metric-value positive';
            } else if (marketData.currentPrice < marketData.vwapLower) {
                positionEl.textContent = 'Below Lower Band';
                positionEl.className = 'metric-value negative';
            } else if (Math.abs(distance) < 0.2) {
                positionEl.textContent = 'Near VWAP';
                positionEl.className = 'metric-value neutral';
            } else if (distance > 0) {
                positionEl.textContent = 'Above VWAP';
                positionEl.className = 'metric-value positive';
            } else {
                positionEl.textContent = 'Below VWAP';
                positionEl.className = 'metric-value negative';
            }
        }

        // Update order book display
        function updateOrderBookDisplay() {
            document.getElementById('obSpread').textContent = formatPrice(marketData.spread);
            document.getElementById('obBids').textContent = formatLargeNumber(marketData.bidTotal);
            document.getElementById('obAsks').textContent = formatLargeNumber(marketData.askTotal);

            const ratio = marketData.bidTotal / marketData.askTotal;
            const ratioEl = document.getElementById('obRatio');
            ratioEl.textContent = ratio.toFixed(3);
            ratioEl.className = 'metric-value ' + (ratio > 1 ? 'positive' : 'negative');

            const pressureEl = document.getElementById('obPressure');
            if (ratio > 1.5) {
                pressureEl.textContent = 'Strong Buy';
                pressureEl.className = 'metric-value positive';
            } else if (ratio > 1.1) {
                pressureEl.textContent = 'Moderate Buy';
                pressureEl.className = 'metric-value positive';
            } else if (ratio < 0.67) {
                pressureEl.textContent = 'Strong Sell';
                pressureEl.className = 'metric-value negative';
            } else if (ratio < 0.9) {
                pressureEl.textContent = 'Moderate Sell';
                pressureEl.className = 'metric-value negative';
            } else {
                pressureEl.textContent = 'Neutral';
                pressureEl.className = 'metric-value neutral';
            }
        }

        // Update futures display
        function updateFuturesDisplay() {
            const fundingEl = document.getElementById('fundingRate');
            fundingEl.textContent = marketData.fundingRate.toFixed(4) + '%';
            fundingEl.className = 'metric-value ' + (marketData.fundingRate >= 0 ? 'positive' : 'negative');

            const annualized = marketData.fundingRate * 3 * 365;
            document.getElementById('fundingAnnualized').textContent = annualized.toFixed(2) + '%';

            const sentimentEl = document.getElementById('fundingSentiment');
            if (marketData.fundingRate > 0.05) {
                sentimentEl.textContent = 'Bullish (strong)';
                sentimentEl.className = 'metric-value positive';
            } else if (marketData.fundingRate > 0.01) {
                sentimentEl.textContent = 'Bullish (moderate)';
                sentimentEl.className = 'metric-value positive';
            } else if (marketData.fundingRate > 0) {
                sentimentEl.textContent = 'Bullish (weak)';
                sentimentEl.className = 'metric-value positive';
            } else if (marketData.fundingRate < -0.05) {
                sentimentEl.textContent = 'Bearish (strong)';
                sentimentEl.className = 'metric-value negative';
            } else if (marketData.fundingRate < -0.01) {
                sentimentEl.textContent = 'Bearish (moderate)';
                sentimentEl.className = 'metric-value negative';
            } else if (marketData.fundingRate < 0) {
                sentimentEl.textContent = 'Bearish (weak)';
                sentimentEl.className = 'metric-value negative';
            } else {
                sentimentEl.textContent = 'Neutral';
                sentimentEl.className = 'metric-value neutral';
            }

            document.getElementById('openInterest').textContent = formatLargeNumber(marketData.openInterest);

            const oiChangeEl = document.getElementById('oiChange');
            oiChangeEl.textContent = '—';
        }

        // Update spot vs futures display
        function updateSpotFuturesDisplay() {
            const spotVol = marketData.spotVolume;
            const futVol = marketData.futuresVolume;

            document.getElementById('spotVolume').textContent = formatLargeNumber(spotVol);
            document.getElementById('futuresVolume').textContent = formatLargeNumber(futVol);

            const ratio = spotVol / futVol;
            const ratioEl = document.getElementById('sfRatio');
            ratioEl.textContent = ratio.toFixed(3);
            ratioEl.className = 'metric-value ' + (ratio > 0.5 ? 'positive' : 'negative');

            const domEl = document.getElementById('sfDominance');
            if (ratio > 1) {
                domEl.textContent = 'Spot Led';
                domEl.className = 'metric-value positive';
            } else if (ratio > 0.5) {
                domEl.textContent = 'Balanced';
                domEl.className = 'metric-value neutral';
            } else {
                domEl.textContent = 'Futures Led';
                domEl.className = 'metric-value negative';
            }

            document.getElementById('sfPriceGap').textContent = '~0.01%';
        }

        // Update Price-OI analysis display
        function updatePriceOIDisplay() {
            const lsRatio = marketData.longShortRatio;
            const change = marketData.change24h;

            const statusEl = document.getElementById('poiStatus');
            const riskEl = document.getElementById('poiRisk');
            const divEl = document.getElementById('poiDivergence');

            // Determine status based on price change and long/short ratio
            if (change > 2 && lsRatio > 1.2) {
                statusEl.textContent = 'Bullish';
                statusEl.className = 'metric-value positive';
            } else if (change < -2 && lsRatio < 0.8) {
                statusEl.textContent = 'Bearish';
                statusEl.className = 'metric-value negative';
            } else {
                statusEl.textContent = 'Neutral';
                statusEl.className = 'metric-value neutral';
            }

            // Risk level based on extreme positions
            if (lsRatio > 2 || lsRatio < 0.5) {
                riskEl.textContent = 'High';
                riskEl.className = 'metric-value negative';
            } else if (lsRatio > 1.5 || lsRatio < 0.67) {
                riskEl.textContent = 'Medium';
                riskEl.className = 'metric-value neutral';
            } else {
                riskEl.textContent = 'Low';
                riskEl.className = 'metric-value positive';
            }

            const priceChangeEl = document.getElementById('poiPriceChange');
            priceChangeEl.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
            priceChangeEl.className = 'metric-value ' + (change >= 0 ? 'positive' : 'negative');

            const lsEl = document.getElementById('longShortRatio');
            lsEl.textContent = lsRatio.toFixed(2);
            lsEl.className = 'metric-value ' + (lsRatio > 1 ? 'positive' : lsRatio < 1 ? 'negative' : 'neutral');

            // Check for divergence
            if ((change > 1 && lsRatio < 0.9) || (change < -1 && lsRatio > 1.1)) {
                divEl.textContent = 'Detected';
                divEl.className = 'metric-value negative';
            } else {
                divEl.textContent = 'None';
                divEl.className = 'metric-value neutral';
            }
        }

        // Update price levels
        function updatePriceLevels() {
            const levels = [
                { price: marketData.weeklyOpen, label: 'Weekly Open', type: 'resistance' },
                { price: marketData.vwapUpper, label: 'VWAP Upper Band (1σ)', type: 'resistance' },
                { price: marketData.dailyHigh, label: '24h High', type: 'resistance' },
                { price: marketData.vwap, label: 'VWAP (15m)', type: 'neutral' },
                { price: marketData.currentPrice, label: 'Current Price', type: 'current' },
                { price: marketData.dailyLow, label: '24h Low', type: 'support' },
                { price: marketData.vwapLower, label: 'VWAP Lower Band (1σ)', type: 'support' },
                { price: marketData.monthlyOpen, label: 'Monthly Open', type: 'support' }
            ].filter(l => l.price > 0);

            // Sort by price descending
            levels.sort((a, b) => b.price - a.price);

            const container = document.getElementById('priceLevels');
            container.innerHTML = '';

            levels.forEach(level => {
                const distance = ((marketData.currentPrice - level.price) / level.price * 100);
                const distanceText = level.type === 'current' ? '—' :
                    (distance >= 0 ? '+' : '') + distance.toFixed(2) + '%';

                const div = document.createElement('div');
                div.className = 'level' + (level.type === 'current' ? ' current' : '');
                div.innerHTML = `
                    <div>
                        <div class="level-price" ${level.type === 'current' ? 'style="color: var(--accent);"' : ''}>
                            ${formatPrice(level.price, 0)}
                        </div>
                        <div class="level-label">${level.label}</div>
                    </div>
                    <div class="level-distance">${distanceText}</div>
                `;
                container.appendChild(div);
            });

            updateTradingScenarios();
            updateMarketSignals();
            updateTradingBias();
        }

        // Update market signals
        function updateMarketSignals() {
            const bullishSignals = [];
            const bearishSignals = [];

            // Order book analysis
            const obRatio = marketData.bidTotal / marketData.askTotal;
            if (obRatio > 1.3) {
                bullishSignals.push('Strong buy pressure in order book');
            } else if (obRatio < 0.7) {
                bearishSignals.push('Strong sell pressure in order book');
            }

            // Funding rate
            if (marketData.fundingRate > 0.01) {
                bullishSignals.push('Positive funding rate');
            } else if (marketData.fundingRate < -0.01) {
                bearishSignals.push('Negative funding rate');
            }

            // VWAP position
            if (marketData.currentPrice > marketData.vwap) {
                bullishSignals.push('Price above VWAP');
            } else {
                bearishSignals.push('Price below VWAP');
            }

            // Price vs monthly open
            if (marketData.currentPrice > marketData.monthlyOpen) {
                bullishSignals.push('Price above Monthly Open');
            } else {
                bearishSignals.push('Price below Monthly Open');
            }

            // Long/short ratio
            if (marketData.longShortRatio > 1.2) {
                bullishSignals.push('More longs than shorts');
            } else if (marketData.longShortRatio < 0.8) {
                bearishSignals.push('More shorts than longs');
            }

            // 24h change
            if (marketData.change24h > 2) {
                bullishSignals.push('Strong 24h momentum (+' + marketData.change24h.toFixed(1) + '%)');
            } else if (marketData.change24h < -2) {
                bearishSignals.push('Weak 24h momentum (' + marketData.change24h.toFixed(1) + '%)');
            }

            // Spot vs futures
            const sfRatio = marketData.spotVolume / marketData.futuresVolume;
            if (sfRatio < 0.3) {
                bearishSignals.push('Futures-dominated market');
            } else if (sfRatio > 0.7) {
                bullishSignals.push('Healthy spot volume');
            }

            // Price near high/low
            const range = marketData.high24h - marketData.low24h;
            const posInRange = (marketData.currentPrice - marketData.low24h) / range;
            if (posInRange > 0.8) {
                bullishSignals.push('Price near daily high');
            } else if (posInRange < 0.2) {
                bearishSignals.push('Price near daily low');
            }

            // Update bullish signals list
            const bullishList = document.getElementById('bullishSignals');
            if (bullishSignals.length > 0) {
                bullishList.innerHTML = bullishSignals.map(s => `<li>${s}</li>`).join('');
            } else {
                bullishList.innerHTML = '<li>No strong bullish signals</li>';
            }

            // Update bearish signals list
            const bearishList = document.getElementById('bearishSignals');
            if (bearishSignals.length > 0) {
                bearishList.innerHTML = bearishSignals.map(s => `<li>${s}</li>`).join('');
            } else {
                bearishList.innerHTML = '<li>No strong bearish signals</li>';
            }
        }

        // Update trading scenarios
        function updateTradingScenarios() {
            const price = marketData.currentPrice;
            const resistance = Math.max(marketData.dailyHigh, marketData.vwapUpper);
            const support = Math.min(marketData.dailyLow, marketData.vwapLower);

            // Calculate dynamic targets
            const range = marketData.high24h - marketData.low24h;
            const bullishT1 = price + (range * 0.5);
            const bullishT2 = price + range;
            const bearishT1 = price - (range * 0.5);
            const bearishT2 = price - range;

            // Calculate probabilities based on market conditions
            let bullishProb = 30;
            let neutralProb = 40;
            let bearishProb = 30;

            // Adjust based on signals
            if (marketData.currentPrice > marketData.vwap) bullishProb += 10;
            if (marketData.currentPrice < marketData.vwap) bearishProb += 10;
            if (marketData.fundingRate > 0.02) bullishProb += 5;
            if (marketData.fundingRate < -0.02) bearishProb += 5;
            if (marketData.bidTotal / marketData.askTotal > 1.3) bullishProb += 10;
            if (marketData.bidTotal / marketData.askTotal < 0.7) bearishProb += 10;
            if (marketData.change24h > 2) bullishProb += 10;
            if (marketData.change24h < -2) bearishProb += 10;

            // Normalize
            const total = bullishProb + neutralProb + bearishProb;
            bullishProb = Math.round(bullishProb / total * 100);
            bearishProb = Math.round(bearishProb / total * 100);
            neutralProb = 100 - bullishProb - bearishProb;

            // Update bullish scenario
            document.getElementById('bullishTrigger').textContent =
                `Break above ${formatPrice(resistance, 0)} with volume`;
            document.getElementById('bullishT1').textContent = formatPrice(bullishT1, 0);
            document.getElementById('bullishT2').textContent = formatPrice(bullishT2, 0);
            document.getElementById('bullishProb').textContent = bullishProb + '%';
            document.getElementById('bullishBar').style.width = bullishProb + '%';

            // Update neutral scenario
            document.getElementById('neutralTrigger').textContent =
                `Consolidation in current range`;
            document.getElementById('neutralHigh').textContent = formatPrice(resistance, 0);
            document.getElementById('neutralLow').textContent = formatPrice(support, 0);
            document.getElementById('neutralProb').textContent = neutralProb + '%';
            document.getElementById('neutralBar').style.width = neutralProb + '%';

            // Update bearish scenario
            document.getElementById('bearishTrigger').textContent =
                `Break below ${formatPrice(support, 0)}`;
            document.getElementById('bearishT1').textContent = formatPrice(bearishT1, 0);
            document.getElementById('bearishT2').textContent = formatPrice(bearishT2, 0);
            document.getElementById('bearishProb').textContent = bearishProb + '%';
            document.getElementById('bearishBar').style.width = bearishProb + '%';
        }

        // Update trading bias
        function updateTradingBias() {
            const stEl = document.getElementById('biasShortTerm');
            const mtEl = document.getElementById('biasMediumTerm');
            const convEl = document.getElementById('biasConviction');
            const watchEl = document.getElementById('watchLevels');

            // Short-term bias based on immediate signals
            const vwapPos = marketData.currentPrice > marketData.vwap;
            const obBullish = (marketData.bidTotal / marketData.askTotal) > 1.1;
            const fundingBullish = marketData.fundingRate > 0;

            let bullishCount = 0;
            if (vwapPos) bullishCount++;
            if (obBullish) bullishCount++;
            if (fundingBullish) bullishCount++;
            if (marketData.change24h > 0) bullishCount++;

            if (bullishCount >= 3) {
                stEl.textContent = 'Bullish';
                stEl.className = 'bias-value positive';
            } else if (bullishCount <= 1) {
                stEl.textContent = 'Bearish';
                stEl.className = 'bias-value negative';
            } else {
                stEl.textContent = 'Neutral';
                stEl.className = 'bias-value neutral';
            }

            // Medium-term based on price position
            if (marketData.currentPrice > marketData.weeklyOpen) {
                mtEl.textContent = 'Bullish';
                mtEl.className = 'bias-value positive';
            } else if (marketData.currentPrice < marketData.monthlyOpen) {
                mtEl.textContent = 'Bearish';
                mtEl.className = 'bias-value negative';
            } else {
                mtEl.textContent = 'Range-bound';
                mtEl.className = 'bias-value neutral';
            }

            // Conviction based on signal agreement
            const signals = [vwapPos, obBullish, fundingBullish, marketData.change24h > 0];
            const agreement = Math.max(signals.filter(s => s).length, signals.filter(s => !s).length);

            if (agreement >= 4) {
                convEl.textContent = 'High';
                convEl.className = 'bias-value positive';
            } else if (agreement >= 3) {
                convEl.textContent = 'Medium';
                convEl.className = 'bias-value neutral';
            } else {
                convEl.textContent = 'Low';
                convEl.className = 'bias-value negative';
            }

            // Watch levels
            const resistance = Math.max(marketData.dailyHigh, marketData.vwapUpper);
            const support = Math.min(marketData.dailyLow, marketData.vwapLower);
            watchEl.innerHTML =
                `Resistance: ${formatPrice(resistance, 0)} (break = bullish)<br>` +
                `Support: ${formatPrice(support, 0)} (break = bearish)`;
        }

        // Fetch all data
        async function fetchAllData() {
            await fetchSpotTicker();

            // Fetch all other data in parallel
            await Promise.all([
                fetchOrderBook(),
                fetchFundingRate(),
                fetchOpenInterest(),
                fetchFuturesTicker(),
                fetchLongShortRatio(),
                fetchVWAP(),
                fetchKeyLevels()
            ]);
        }

        window.addEventListener('DOMContentLoaded', () => {
            const button = document.querySelector('.theme-toggle');
            if (currentTheme === 'day') {
                document.documentElement.setAttribute('data-theme', 'day');
                button.textContent = 'Night Mode';
            }

            fetchAllData();
            initTradingView();

            // Refresh data every 30 seconds
            setInterval(fetchAllData, 30000);
        });

        function initTradingView() {
            const container = document.getElementById('tradingview_chart');
            if (!container) return;

            container.innerHTML = '';

            const isDark = currentTheme === 'night';

            new TradingView.widget({
                "autosize": true,
                "symbol": "BINANCE:BTCUSDT",
                "interval": "15",
                "timezone": "Etc/UTC",
                "theme": isDark ? "dark" : "light",
                "style": "1",
                "locale": "en",
                "toolbar_bg": isDark ? "#0a0a0a" : "#fafafa",
                "enable_publishing": false,
                "hide_side_toolbar": false,
                "allow_symbol_change": false,
                "studies": ["VWAP@tv-basicstudies"],
                "container_id": "tradingview_chart",
                "hide_top_toolbar": false,
                "save_image": false,
                "backgroundColor": isDark ? "#0a0a0a" : "#ffffff",
                "gridColor": isDark ? "#1a1a1a" : "#e5e5e5",
                "hide_legend": false,
                "withdateranges": true,
                "range": "1D",
                "details": true,
                "hotlist": false,
                "calendar": false,
                "show_popup_button": false,
                "drawings_access": {
                    "type": "black",
                    "tools": [{
                        "name": "Horizontal Line",
                        "grayed": false
                    }]
                },
                "overrides": {
                    "paneProperties.background": isDark ? "#0a0a0a" : "#ffffff",
                    "paneProperties.backgroundType": "solid"
                }
            });
        }
    </script>
</body>
</html>
