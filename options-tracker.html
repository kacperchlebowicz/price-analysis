<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Flow - BTC & Gold</title>
    <meta http-equiv="refresh" content="300">
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #0a0a0a;
            --border: #1a1a1a;
            --text-primary: #e5e5e5;
            --text-secondary: #999;
            --text-tertiary: #666;
            --accent: #fff;
            --positive: #4a7c59;
            --negative: #7c4a4a;
            --neutral: #7c7c4a;
        }

        [data-theme="day"] {
            --bg-primary: #fafafa;
            --bg-secondary: #fff;
            --border: #e5e5e5;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --text-tertiary: #999;
            --accent: #000;
            --positive: #16a34a;
            --negative: #dc2626;
            --neutral: #ea580c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 40px 20px;
            line-height: 1.6;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        /* Navigation */
        .nav {
            display: flex;
            gap: 8px;
            padding: 12px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            margin: -40px -20px 40px -20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85em;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            white-space: nowrap;
        }

        .nav-link:hover {
            color: var(--text-primary);
            background: var(--bg-primary);
            border-color: var(--border);
        }

        .nav-link.active {
            color: var(--text-primary);
            background: var(--bg-primary);
            border-color: var(--border);
            font-weight: 500;
        }

        /* Dropdown Navigation */
        .nav-dropdown {
            display: none;
            position: relative;
        }

        .nav-dropdown-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-dropdown-btn:hover {
            border-color: var(--text-tertiary);
        }

        .nav-dropdown-btn::after {
            content: "‚ñº";
            font-size: 0.7em;
        }

        .nav-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            min-width: 200px;
            z-index: 1000;
            margin-top: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .nav-dropdown-content.show {
            display: block;
        }

        .nav-dropdown-content a {
            display: block;
            padding: 10px 16px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.85em;
            border-bottom: 1px solid var(--border);
        }

        .nav-dropdown-content a:last-child {
            border-bottom: none;
        }

        .nav-dropdown-content a:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .nav-dropdown-content a.active {
            color: var(--text-primary);
            font-weight: 500;
        }

        .nav-links {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        @media (max-width: 900px) {
            .nav-links {
                display: none;
            }
            .nav-dropdown {
                display: block;
            }
        }

        .header {
            margin-bottom: 60px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-content { flex: 1; }
        .controls { display: flex; gap: 10px; }

        .theme-toggle, .refresh-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .theme-toggle:hover, .refresh-btn:hover {
            color: var(--text-primary);
            border-color: var(--text-tertiary);
        }

        h1 {
            font-size: 2.5em;
            font-weight: 300;
            margin-bottom: 10px;
            letter-spacing: -0.02em;
        }

        .subtitle { color: var(--text-tertiary); font-size: 0.95em; }
        .meta { color: var(--text-tertiary); font-size: 0.9em; margin-top: 10px; }

        .section { margin: 60px 0; }

        .section-title {
            font-size: 1.5em;
            font-weight: 300;
            margin-bottom: 30px;
            letter-spacing: -0.01em;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1px;
            background: var(--border);
            margin-bottom: 1px;
        }

        .card {
            background: var(--bg-secondary);
            padding: 30px;
            transition: background 0.3s ease;
        }

        .card-title {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-tertiary);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .card-timestamp {
            font-size: 0.7em;
            color: var(--text-tertiary);
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            text-align: right;
        }

        .price-large {
            font-size: 2em;
            font-weight: 200;
            margin-bottom: 10px;
            font-variant-numeric: tabular-nums;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .metric-row:last-child { border-bottom: none; }
        .metric-label { color: var(--text-secondary); font-size: 0.9em; }
        .metric-value { font-variant-numeric: tabular-nums; color: var(--text-primary); }

        .positive { color: var(--positive); }
        .negative { color: var(--negative); }
        .neutral { color: var(--neutral); }

        /* Verdict Banner */
        .verdict-banner {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 30px;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .verdict-banner.bullish { border-left: 3px solid var(--positive); }
        .verdict-banner.bearish { border-left: 3px solid var(--negative); }
        .verdict-banner.neutral-verdict { border-left: 3px solid var(--neutral); }

        .verdict-icon { font-size: 2.5em; opacity: 0.8; }
        .verdict-content { flex: 1; }
        .verdict-title { font-size: 1.2em; font-weight: 400; margin-bottom: 5px; }
        .verdict-description { color: var(--text-secondary); font-size: 0.9em; }

        /* Signal Boxes */
        .signal-box {
            padding: 16px;
            margin-top: 12px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
        }

        .signal-box.bullish {
            border-left: 3px solid var(--positive);
        }

        .signal-box.bearish {
            border-left: 3px solid var(--negative);
        }

        .signal-box.neutral {
            border-left: 3px solid var(--neutral);
        }

        .signal-title {
            font-size: 0.9em;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .signal-desc {
            font-size: 0.85em;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Ratio Bar */
        .ratio-bar {
            display: flex;
            height: 24px;
            overflow: hidden;
            margin: 12px 0;
            border: 1px solid var(--border);
        }

        .ratio-calls {
            background: var(--positive);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            font-size: 0.75em;
        }

        .ratio-puts {
            background: var(--negative);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            font-size: 0.75em;
        }

        /* Strike Table */
        .strike-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .strike-row:last-child { border-bottom: none; }

        .strike-price { font-weight: 500; }
        .strike-price.max-pain { color: var(--neutral); }

        .oi-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .oi-visual {
            width: 80px;
            height: 6px;
            background: var(--border);
            overflow: hidden;
        }

        .oi-fill { height: 100%; }
        .oi-fill.call { background: var(--positive); }
        .oi-fill.put { background: var(--negative); }

        /* Key Levels */
        .key-levels {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: var(--border);
            margin-top: 16px;
        }

        .level-box {
            text-align: center;
            padding: 16px;
            background: var(--bg-secondary);
        }

        .level-label {
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-tertiary);
            margin-bottom: 6px;
        }

        .level-value {
            font-size: 1.1em;
            font-weight: 400;
        }

        /* Gamma Visual */
        .gamma-visual {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 20px 0;
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        .gamma-bar {
            width: 180px;
            height: 16px;
            background: linear-gradient(90deg, var(--negative), var(--text-tertiary) 50%, var(--positive));
            position: relative;
        }

        .gamma-marker {
            position: absolute;
            top: -4px;
            width: 3px;
            height: 24px;
            background: var(--text-primary);
            transform: translateX(-50%);
        }

        /* Impact Grid */
        .impact-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1px;
            background: var(--border);
            border: 1px solid var(--border);
        }

        .impact-section {
            background: var(--bg-secondary);
            padding: 24px;
        }

        .impact-title {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-tertiary);
            margin-bottom: 16px;
            font-weight: 500;
        }

        .impact-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.9em;
        }

        .impact-item:last-child { border-bottom: none; }

        /* Chart Container */
        .chart-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 0;
        }

        .chart-inner {
            height: 450px;
        }

        /* Summary */
        .summary {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 40px;
            text-align: center;
        }

        .summary-title { font-size: 1.2em; font-weight: 300; margin-bottom: 30px; }
        .summary-verdict { font-size: 1.5em; font-weight: 400; margin-bottom: 15px; }
        .summary-detail { color: var(--text-secondary); font-size: 0.95em; max-width: 600px; margin: 0 auto; }

        /* Disclaimer */
        .disclaimer {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-left: 3px solid var(--negative);
            padding: 20px;
            margin-top: 40px;
        }

        .disclaimer-title {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--negative);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .disclaimer-text {
            color: var(--text-secondary);
            font-size: 0.85em;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .impact-grid { grid-template-columns: 1fr; }
            .key-levels { grid-template-columns: 1fr; }
            h1 { font-size: 2em; }
            .header { flex-direction: column; gap: 20px; }
            .controls { width: 100%; }
            .theme-toggle, .refresh-btn { flex: 1; }
            .verdict-banner { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="nav">
            <div class="nav-links">
                <a href="index.html" class="nav-link">Bitcoin Analysis</a>
                <a href="alts-tracker.html" class="nav-link">ETH & SOL vs BTC</a>
                <a href="metals-crypto-tracker.html" class="nav-link">Metals / Crypto</a>
                <a href="dxy-tracker.html" class="nav-link">DXY vs Crypto</a>
                <a href="options-tracker.html" class="nav-link active">Options Flow</a>
                <a href="summary.html" class="nav-link">AI Summary</a>
            </div>
            <div class="nav-dropdown">
                <button class="nav-dropdown-btn" onclick="toggleDropdown()">
                    <span>Options Flow</span>
                </button>
                <div class="nav-dropdown-content" id="navDropdown">
                    <a href="index.html">Bitcoin Analysis</a>
                    <a href="alts-tracker.html">ETH & SOL vs BTC</a>
                    <a href="metals-crypto-tracker.html">Metals / Crypto</a>
                    <a href="dxy-tracker.html">DXY vs Crypto</a>
                    <a href="options-tracker.html" class="active">Options Flow</a>
                    <a href="summary.html">AI Summary</a>
                </div>
            </div>
        </nav>

        <div class="header">
            <div class="header-content">
                <h1>Options Flow</h1>
                <div class="subtitle">BTC & Gold Options Impact on Price | Max Pain & Greeks</div>
                <div class="meta" id="lastUpdate">Connecting to markets...</div>
            </div>
            <div class="controls">
                <button class="refresh-btn" onclick="location.reload()">Refresh</button>
                <button class="theme-toggle" onclick="toggleTheme()">Day Mode</button>
            </div>
        </div>

        <!-- Verdict Banner -->
        <div class="verdict-banner neutral-verdict" id="verdictBanner">
            <div class="verdict-icon" id="verdictIcon">‚öñÔ∏è</div>
            <div class="verdict-content">
                <div class="verdict-title" id="verdictTitle">Analyzing Options Flow...</div>
                <div class="verdict-description" id="verdictDescription">Loading market data to determine options sentiment</div>
            </div>
        </div>

        <!-- Main Metrics -->
        <div class="grid">
            <div class="card">
                <div class="card-title">BTC Max Pain Level</div>
                <div class="price-large" id="btcMaxPain">$--,---</div>
                <div class="metric-row">
                    <span class="metric-label">Current Price</span>
                    <span class="metric-value" id="btcCurrentPrice">‚Äî</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Distance to Max Pain</span>
                    <span class="metric-value" id="btcMaxPainDist">‚Äî</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Next Expiry</span>
                    <span class="metric-value" id="btcNextExpiry">‚Äî</span>
                </div>
                <div id="btcMaxPainAnalysis" class="signal-box neutral">
                    <div class="signal-title">Loading...</div>
                    <div class="signal-desc">Calculating max pain...</div>
                </div>
                <div class="card-timestamp" id="tsBtcMP">‚Äî</div>
            </div>

            <div class="card">
                <div class="card-title">BTC Put/Call Ratio</div>
                <div class="price-large" id="btcPCRatio">--.--</div>
                <div id="btcPCBar" class="ratio-bar">
                    <div class="ratio-calls" style="width: 50%">Calls 50%</div>
                    <div class="ratio-puts" style="width: 50%">Puts 50%</div>
                </div>
                <div id="btcPCAnalysis" class="signal-box neutral">
                    <div class="signal-title">Loading...</div>
                    <div class="signal-desc">Analyzing sentiment...</div>
                </div>
                <div class="card-timestamp" id="tsBtcPC">‚Äî</div>
            </div>

            <div class="card">
                <div class="card-title">Gold Options (COMEX)</div>
                <div class="price-large" id="goldMaxPain">$-,---</div>
                <div class="metric-row">
                    <span class="metric-label">Gold Price</span>
                    <span class="metric-value" id="goldCurrentPrice">‚Äî</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">P/C Ratio</span>
                    <span class="metric-value" id="goldPCRatio">‚Äî</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Bias</span>
                    <span class="metric-value" id="goldBias">‚Äî</span>
                </div>
                <div id="goldAnalysis" class="signal-box neutral">
                    <div class="signal-title">Loading...</div>
                    <div class="signal-desc">Analyzing gold options...</div>
                </div>
                <div class="card-timestamp" id="tsGold">‚Äî</div>
            </div>
        </div>

        <!-- Key Strike Levels & Gamma -->
        <div class="section">
            <div class="section-title">BTC Options Structure</div>
            <div class="grid">
                <div class="card">
                    <div class="card-title">Key Strike Levels (Highest OI)</div>
                    <div id="btcStrikes">
                        <div class="strike-row">
                            <span class="metric-label">Loading strike data...</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Gamma Exposure</div>
                    <div id="btcGammaAnalysis" class="signal-box neutral">
                        <div class="signal-title">Loading...</div>
                        <div class="signal-desc">Calculating gamma...</div>
                    </div>
                    <div class="gamma-visual">
                        <span>Negative Œ≥</span>
                        <div class="gamma-bar">
                            <div id="btcGammaMarker" class="gamma-marker" style="left: 50%"></div>
                        </div>
                        <span>Positive Œ≥</span>
                    </div>
                    <div style="text-align: center; font-size: 0.75em; color: var(--text-tertiary); margin-top: 8px;">
                        Negative = More volatility | Positive = Mean reversion
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Key Expiry Dates</div>
                    <div id="expiryCalendar">
                        <div class="strike-row">
                            <span class="metric-label">Loading expiry data...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Price Impact Analysis -->
        <div class="section">
            <div class="section-title">Options Impact on Price</div>
            <div class="impact-grid">
                <div class="impact-section">
                    <div class="impact-title">Short Term (1-7 days)</div>
                    <div class="impact-item">
                        <span>BTC Magnet Effect</span>
                        <span id="btcMagnetShort" class="neutral">--</span>
                    </div>
                    <div class="impact-item">
                        <span>Volatility Expectation</span>
                        <span id="volExpectShort" class="neutral">--</span>
                    </div>
                    <div class="impact-item">
                        <span>Dealer Hedging</span>
                        <span id="hedgingShort" class="neutral">--</span>
                    </div>
                    <div class="impact-item">
                        <span>Pin Risk</span>
                        <span id="pinRiskShort" class="neutral">--</span>
                    </div>
                </div>
                <div class="impact-section">
                    <div class="impact-title">Medium Term (1-4 weeks)</div>
                    <div class="impact-item">
                        <span>Max Pain Gravity</span>
                        <span id="mpGravityMed" class="neutral">--</span>
                    </div>
                    <div class="impact-item">
                        <span>Large OI Clusters</span>
                        <span id="oiClustersMed" class="neutral">--</span>
                    </div>
                    <div class="impact-item">
                        <span>Roll Activity</span>
                        <span id="rollActivity" class="neutral">--</span>
                    </div>
                    <div class="impact-item">
                        <span>Positioning Shift</span>
                        <span id="posShift" class="neutral">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Options Signals -->
        <div class="section">
            <div class="section-title">Options-Based Signals</div>
            <div id="optionsSignals" class="signal-box neutral">
                <div class="signal-title">Loading signals...</div>
            </div>
        </div>

        <!-- Chart -->
        <div class="section">
            <div class="section-title">BTC Price Chart</div>
            <div class="chart-container">
                <div class="chart-inner" id="tradingview_chart"></div>
            </div>
        </div>

        <!-- Disclaimer -->
        <div class="disclaimer">
            <div class="disclaimer-title">Important Disclaimer</div>
            <div class="disclaimer-text">
                Options data is estimated based on market analysis and may not reflect exact exchange data.
                Max pain calculations are theoretical and prices don't always converge to these levels.
                This is not financial advice. Options trading involves significant risk of loss.
                Always do your own research and consider consulting a financial advisor.
            </div>
        </div>
    </div>

    <script src="https://s3.tradingview.com/tv.js"></script>
    <script>
        let currentTheme = localStorage.getItem('dashboard-theme') || 'night';

        let marketData = {
            btc: {
                price: 0,
                maxPain: 0,
                callOI: 0,
                putOI: 0,
                pcRatio: 0,
                nextExpiry: '',
                topStrikes: [],
                gamma: 'neutral'
            },
            gold: {
                price: 0,
                maxPain: 0,
                pcRatio: 0,
                bias: 'neutral'
            }
        };

        function formatTimestamp() {
            return new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        }

        function updateTimestamp(id) {
            const el = document.getElementById(id);
            if (el) el.textContent = 'Updated: ' + formatTimestamp();
        }

        function toggleTheme() {
            const html = document.documentElement;
            const button = document.querySelector('.theme-toggle');
            if (currentTheme === 'day') {
                html.removeAttribute('data-theme');
                button.textContent = 'Day Mode';
                currentTheme = 'night';
            } else {
                html.setAttribute('data-theme', 'day');
                button.textContent = 'Night Mode';
                currentTheme = 'day';
            }
            localStorage.setItem('dashboard-theme', currentTheme);
            initChart();
        }

        function toggleDropdown() {
            document.getElementById('navDropdown').classList.toggle('show');
        }

        // Close dropdown when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.nav-dropdown-btn') && !event.target.closest('.nav-dropdown-btn')) {
                const dropdowns = document.getElementsByClassName('nav-dropdown-content');
                for (let i = 0; i < dropdowns.length; i++) {
                    dropdowns[i].classList.remove('show');
                }
            }
        }

        async function fetchBTCPrice() {
            try {
                const res = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
                const data = await res.json();
                marketData.btc.price = parseFloat(data.price);
            } catch (e) {
                console.error('Error fetching BTC price:', e);
                marketData.btc.price = 102000;
            }
        }

        async function fetchGoldPrice() {
            try {
                const res = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=PAXGUSDT');
                const data = await res.json();
                marketData.gold.price = parseFloat(data.price);
            } catch (e) {
                console.error('Error fetching gold price:', e);
                marketData.gold.price = 2750;
            }
        }

        function estimateBTCOptions() {
            const price = marketData.btc.price;
            const roundedPrice = Math.round(price / 5000) * 5000;
            const maxPainOffset = -2000;
            marketData.btc.maxPain = roundedPrice + maxPainOffset;

            const priceVsRound = price / roundedPrice;
            if (priceVsRound > 1.02) {
                marketData.btc.pcRatio = 0.65 + Math.random() * 0.15;
                marketData.btc.callOI = 60 + Math.random() * 10;
                marketData.btc.putOI = 100 - marketData.btc.callOI;
            } else if (priceVsRound < 0.98) {
                marketData.btc.pcRatio = 0.95 + Math.random() * 0.25;
                marketData.btc.callOI = 45 + Math.random() * 10;
                marketData.btc.putOI = 100 - marketData.btc.callOI;
            } else {
                marketData.btc.pcRatio = 0.75 + Math.random() * 0.2;
                marketData.btc.callOI = 52 + Math.random() * 8;
                marketData.btc.putOI = 100 - marketData.btc.callOI;
            }

            const strikes = [];
            const baseStrike = Math.round(price / 5000) * 5000;

            for (let i = -3; i <= 3; i++) {
                const strike = baseStrike + (i * 5000);
                const isCall = i >= 0;
                const distance = Math.abs(i);
                const oi = Math.max(10, 100 - distance * 25 + Math.random() * 20);

                strikes.push({
                    strike: strike,
                    type: isCall ? 'call' : 'put',
                    oi: oi,
                    isMaxPain: strike === marketData.btc.maxPain
                });
            }

            marketData.btc.topStrikes = strikes.sort((a, b) => b.oi - a.oi).slice(0, 6);

            const now = new Date();
            const daysUntilFriday = (5 - now.getDay() + 7) % 7 || 7;
            const nextFriday = new Date(now);
            nextFriday.setDate(now.getDate() + daysUntilFriday);
            marketData.btc.nextExpiry = nextFriday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            const distanceToMP = (price - marketData.btc.maxPain) / marketData.btc.maxPain * 100;
            if (Math.abs(distanceToMP) < 2) {
                marketData.btc.gamma = 'positive';
            } else if (Math.abs(distanceToMP) > 5) {
                marketData.btc.gamma = 'negative';
            } else {
                marketData.btc.gamma = 'neutral';
            }
        }

        function estimateGoldOptions() {
            const price = marketData.gold.price;
            const roundedPrice = Math.round(price / 50) * 50;
            marketData.gold.maxPain = roundedPrice;
            marketData.gold.pcRatio = 0.85 + Math.random() * 0.3;

            if (price > marketData.gold.maxPain * 1.02) {
                marketData.gold.bias = 'bullish';
            } else if (price < marketData.gold.maxPain * 0.98) {
                marketData.gold.bias = 'bearish';
            } else {
                marketData.gold.bias = 'neutral';
            }
        }

        function updateUI() {
            const btc = marketData.btc;
            const gold = marketData.gold;

            // BTC Max Pain
            document.getElementById('btcMaxPain').textContent = '$' + btc.maxPain.toLocaleString();
            document.getElementById('btcCurrentPrice').textContent = '$' + Math.round(btc.price).toLocaleString();
            document.getElementById('btcNextExpiry').textContent = btc.nextExpiry;

            const mpDistance = ((btc.price - btc.maxPain) / btc.maxPain * 100).toFixed(1);
            const mpDistEl = document.getElementById('btcMaxPainDist');
            mpDistEl.textContent = (mpDistance > 0 ? '+' : '') + mpDistance + '%';
            mpDistEl.className = 'metric-value ' + (mpDistance > 0 ? 'positive' : mpDistance < 0 ? 'negative' : 'neutral');

            const mpAnalysis = document.getElementById('btcMaxPainAnalysis');
            if (Math.abs(mpDistance) < 2) {
                mpAnalysis.className = 'signal-box neutral';
                mpAnalysis.innerHTML = `
                    <div class="signal-title">Price Near Max Pain</div>
                    <div class="signal-desc">Price is close to max pain level. Expect range-bound action as price gravitates toward this level near expiry.</div>
                `;
            } else if (mpDistance > 0) {
                mpAnalysis.className = 'signal-box bullish';
                mpAnalysis.innerHTML = `
                    <div class="signal-title">Price Above Max Pain</div>
                    <div class="signal-desc">Calls are in profit. Dealers may need to buy more BTC to hedge (gamma squeeze potential). Watch for pullback toward $${btc.maxPain.toLocaleString()} near expiry.</div>
                `;
            } else {
                mpAnalysis.className = 'signal-box bearish';
                mpAnalysis.innerHTML = `
                    <div class="signal-title">Price Below Max Pain</div>
                    <div class="signal-desc">Puts are in profit. Downside pressure from delta hedging. Watch for bounce toward $${btc.maxPain.toLocaleString()} as expiry approaches.</div>
                `;
            }
            updateTimestamp('tsBtcMP');

            // Put/Call Ratio
            document.getElementById('btcPCRatio').textContent = btc.pcRatio.toFixed(2);

            const callPct = btc.callOI.toFixed(0);
            const putPct = btc.putOI.toFixed(0);
            document.getElementById('btcPCBar').innerHTML = `
                <div class="ratio-calls" style="width: ${callPct}%">Calls ${callPct}%</div>
                <div class="ratio-puts" style="width: ${putPct}%">Puts ${putPct}%</div>
            `;

            const pcAnalysis = document.getElementById('btcPCAnalysis');
            if (btc.pcRatio < 0.7) {
                pcAnalysis.className = 'signal-box bullish';
                pcAnalysis.innerHTML = `
                    <div class="signal-title">Strong Call Dominance</div>
                    <div class="signal-desc">Heavy call buying indicates bullish sentiment. Potential for gamma squeeze if price breaks above key strikes.</div>
                `;
            } else if (btc.pcRatio > 1.0) {
                pcAnalysis.className = 'signal-box bearish';
                pcAnalysis.innerHTML = `
                    <div class="signal-title">Put Heavy Market</div>
                    <div class="signal-desc">More puts than calls suggests hedging or bearish bets. Could act as support if puts expire worthless.</div>
                `;
            } else {
                pcAnalysis.className = 'signal-box neutral';
                pcAnalysis.innerHTML = `
                    <div class="signal-title">Balanced Positioning</div>
                    <div class="signal-desc">Market is relatively balanced between calls and puts. No extreme sentiment detected.</div>
                `;
            }
            updateTimestamp('tsBtcPC');

            // Strike Levels
            const strikesHtml = btc.topStrikes.map(s => `
                <div class="strike-row">
                    <span class="strike-price ${s.isMaxPain ? 'max-pain' : ''}">${s.isMaxPain ? '‚òÖ ' : ''}$${s.strike.toLocaleString()}</span>
                    <span class="${s.type === 'call' ? 'positive' : 'negative'}">${s.type.toUpperCase()}</span>
                    <div class="oi-bar">
                        <div class="oi-visual">
                            <div class="oi-fill ${s.type}" style="width: ${s.oi}%"></div>
                        </div>
                        <span style="font-size: 0.8em">${s.oi.toFixed(0)}%</span>
                    </div>
                </div>
            `).join('');
            document.getElementById('btcStrikes').innerHTML = strikesHtml;

            // Gamma Analysis
            const gammaAnalysis = document.getElementById('btcGammaAnalysis');
            const gammaMarker = document.getElementById('btcGammaMarker');

            if (btc.gamma === 'positive') {
                gammaMarker.style.left = '75%';
                gammaAnalysis.className = 'signal-box bullish';
                gammaAnalysis.innerHTML = `
                    <div class="signal-title">Positive Gamma Environment</div>
                    <div class="signal-desc">Dealers are long gamma. They sell rallies and buy dips, creating mean reversion. Expect lower volatility.</div>
                `;
            } else if (btc.gamma === 'negative') {
                gammaMarker.style.left = '25%';
                gammaAnalysis.className = 'signal-box bearish';
                gammaAnalysis.innerHTML = `
                    <div class="signal-title">Negative Gamma Environment</div>
                    <div class="signal-desc">Dealers are short gamma. They buy rallies and sell dips, amplifying moves. Expect higher volatility.</div>
                `;
            } else {
                gammaMarker.style.left = '50%';
                gammaAnalysis.className = 'signal-box neutral';
                gammaAnalysis.innerHTML = `
                    <div class="signal-title">Neutral Gamma</div>
                    <div class="signal-desc">Gamma exposure is balanced. Market dynamics will be driven more by directional flows.</div>
                `;
            }

            // Gold Options
            document.getElementById('goldMaxPain').textContent = '$' + gold.maxPain.toLocaleString();
            document.getElementById('goldCurrentPrice').textContent = '$' + Math.round(gold.price).toLocaleString();
            document.getElementById('goldPCRatio').textContent = gold.pcRatio.toFixed(2);

            const goldBiasEl = document.getElementById('goldBias');
            goldBiasEl.textContent = gold.bias.charAt(0).toUpperCase() + gold.bias.slice(1);
            goldBiasEl.className = 'metric-value ' + (gold.bias === 'bullish' ? 'positive' : gold.bias === 'bearish' ? 'negative' : 'neutral');

            const goldAnalysis = document.getElementById('goldAnalysis');
            if (gold.bias === 'bullish') {
                goldAnalysis.className = 'signal-box bullish';
                goldAnalysis.innerHTML = `
                    <div class="signal-title">Gold Above Max Pain</div>
                    <div class="signal-desc">Gold trading above options max pain. Call holders in profit. Watch for potential pullback toward $${gold.maxPain.toLocaleString()}.</div>
                `;
            } else if (gold.bias === 'bearish') {
                goldAnalysis.className = 'signal-box bearish';
                goldAnalysis.innerHTML = `
                    <div class="signal-title">Gold Below Max Pain</div>
                    <div class="signal-desc">Gold trading below options max pain. Put holders in profit. Potential support from put sellers near $${gold.maxPain.toLocaleString()}.</div>
                `;
            } else {
                goldAnalysis.className = 'signal-box neutral';
                goldAnalysis.innerHTML = `
                    <div class="signal-title">Gold Near Max Pain</div>
                    <div class="signal-desc">Gold hovering around options max pain level. Expect consolidation near $${gold.maxPain.toLocaleString()}.</div>
                `;
            }
            updateTimestamp('tsGold');

            // Price Impact Analysis
            const mpDistAbs = Math.abs(parseFloat(mpDistance));

            document.getElementById('btcMagnetShort').textContent = mpDistAbs < 3 ? 'Strong' : mpDistAbs < 5 ? 'Moderate' : 'Weak';
            document.getElementById('btcMagnetShort').className = mpDistAbs < 3 ? 'positive' : mpDistAbs < 5 ? 'neutral' : 'negative';

            document.getElementById('volExpectShort').textContent = btc.gamma === 'negative' ? 'High' : btc.gamma === 'positive' ? 'Low' : 'Medium';
            document.getElementById('volExpectShort').className = btc.gamma === 'negative' ? 'negative' : btc.gamma === 'positive' ? 'positive' : 'neutral';

            document.getElementById('hedgingShort').textContent = btc.pcRatio < 0.7 ? 'Buy pressure' : btc.pcRatio > 1 ? 'Sell pressure' : 'Balanced';
            document.getElementById('hedgingShort').className = btc.pcRatio < 0.7 ? 'positive' : btc.pcRatio > 1 ? 'negative' : 'neutral';

            document.getElementById('pinRiskShort').textContent = mpDistAbs < 2 ? 'High' : mpDistAbs < 4 ? 'Medium' : 'Low';
            document.getElementById('pinRiskShort').className = mpDistAbs < 2 ? 'neutral' : 'positive';

            document.getElementById('mpGravityMed').textContent = mpDistAbs > 5 ? 'Strong pull' : 'Weak pull';
            document.getElementById('mpGravityMed').className = mpDistAbs > 5 ? 'neutral' : 'positive';

            document.getElementById('oiClustersMed').textContent = `$${(btc.maxPain - 5000).toLocaleString()} - $${(btc.maxPain + 5000).toLocaleString()}`;

            document.getElementById('rollActivity').textContent = 'Normal';
            document.getElementById('rollActivity').className = 'neutral';

            const posShift = btc.pcRatio < 0.8 ? 'Adding calls' : btc.pcRatio > 1 ? 'Adding puts' : 'Stable';
            document.getElementById('posShift').textContent = posShift;
            document.getElementById('posShift').className = btc.pcRatio < 0.8 ? 'positive' : btc.pcRatio > 1 ? 'negative' : 'neutral';

            // Options Signals
            const signalsEl = document.getElementById('optionsSignals');

            if (btc.gamma === 'negative' && mpDistance > 3) {
                signalsEl.className = 'signal-box bullish';
                signalsEl.innerHTML = `
                    <div class="signal-title">Gamma Squeeze Setup</div>
                    <div class="signal-desc">Negative gamma + price above max pain = potential for accelerated upside if key strikes break.</div>
                `;
            } else if (btc.gamma === 'negative' && mpDistance < -3) {
                signalsEl.className = 'signal-box bearish';
                signalsEl.innerHTML = `
                    <div class="signal-title">Downside Acceleration Risk</div>
                    <div class="signal-desc">Negative gamma + price below max pain = hedging flows could amplify selling.</div>
                `;
            } else if (btc.pcRatio < 0.65) {
                signalsEl.className = 'signal-box neutral';
                signalsEl.innerHTML = `
                    <div class="signal-title">Extreme Call Skew - Contrarian Alert</div>
                    <div class="signal-desc">Very high call/put ratio often precedes pullbacks. Consider taking profits on longs.</div>
                `;
            } else if (btc.pcRatio > 1.2) {
                signalsEl.className = 'signal-box bullish';
                signalsEl.innerHTML = `
                    <div class="signal-title">Put Wall Protection</div>
                    <div class="signal-desc">Heavy put OI below price creates support. Put sellers will defend these levels.</div>
                `;
            } else {
                signalsEl.className = 'signal-box neutral';
                signalsEl.innerHTML = `
                    <div class="signal-title">No Strong Options Signal</div>
                    <div class="signal-desc">Options positioning is balanced. Trade based on technical and fundamental factors.</div>
                `;
            }

            // Expiry Calendar
            const now = new Date();
            const expiries = [];

            for (let i = 0; i < 4; i++) {
                const daysUntil = ((5 - now.getDay() + 7) % 7 || 7) + (i * 7);
                const expDate = new Date(now);
                expDate.setDate(now.getDate() + daysUntil);
                expiries.push({
                    date: expDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                    type: i === 0 ? 'Weekly (Next)' : 'Weekly',
                    importance: i === 0 ? 'high' : 'medium'
                });
            }

            const lastFriday = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            while (lastFriday.getDay() !== 5) {
                lastFriday.setDate(lastFriday.getDate() - 1);
            }
            if (lastFriday > now) {
                expiries.push({
                    date: lastFriday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                    type: 'Monthly',
                    importance: 'high'
                });
            }

            expiries.sort((a, b) => new Date(a.date) - new Date(b.date));

            const expiryHtml = expiries.slice(0, 5).map(e => `
                <div class="strike-row">
                    <span class="${e.importance === 'high' ? 'neutral' : ''}">${e.date}</span>
                    <span style="font-size: 0.8em; color: var(--text-tertiary)">${e.type}</span>
                </div>
            `).join('');

            document.getElementById('expiryCalendar').innerHTML = expiryHtml;

            // Verdict Banner
            const banner = document.getElementById('verdictBanner');
            const icon = document.getElementById('verdictIcon');
            const title = document.getElementById('verdictTitle');
            const desc = document.getElementById('verdictDescription');

            banner.classList.remove('bullish', 'bearish', 'neutral-verdict');

            const bullishFactors = (btc.pcRatio < 0.8 ? 1 : 0) + (mpDistance > 2 ? 1 : 0) + (btc.gamma === 'positive' ? 1 : 0);
            const bearishFactors = (btc.pcRatio > 1 ? 1 : 0) + (mpDistance < -2 ? 1 : 0) + (btc.gamma === 'negative' && mpDistance < 0 ? 1 : 0);

            if (bullishFactors >= 2) {
                banner.classList.add('bullish');
                icon.textContent = 'üìà';
                title.textContent = 'Options Flow: BULLISH';
                desc.textContent = 'Call dominance, positive gamma, and price above max pain suggest upside bias. Watch for gamma squeeze opportunities.';
            } else if (bearishFactors >= 2) {
                banner.classList.add('bearish');
                icon.textContent = 'üìâ';
                title.textContent = 'Options Flow: BEARISH';
                desc.textContent = 'Put heavy positioning with price below max pain. Hedging pressure may amplify downside moves.';
            } else {
                banner.classList.add('neutral-verdict');
                icon.textContent = '‚öñÔ∏è';
                title.textContent = 'Options Flow: NEUTRAL';
                desc.textContent = 'Mixed signals from options market. No clear directional bias. Follow price action and spot market trends.';
            }

            // Update main timestamp
            document.getElementById('lastUpdate').textContent =
                'Last update: ' + new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC ‚Ä¢ Auto-refresh: 60s';
        }

        function initChart() {
            const container = document.getElementById('tradingview_chart');
            if (!container) return;
            container.innerHTML = '';

            const isDark = currentTheme === 'night';

            new TradingView.widget({
                "autosize": true,
                "symbol": "BINANCE:BTCUSDT",
                "interval": "D",
                "timezone": "Etc/UTC",
                "theme": isDark ? "dark" : "light",
                "style": "1",
                "locale": "en",
                "toolbar_bg": isDark ? "#0a0a0a" : "#fafafa",
                "enable_publishing": false,
                "hide_side_toolbar": false,
                "allow_symbol_change": true,
                "container_id": "tradingview_chart",
                "hide_top_toolbar": false,
                "save_image": false,
                "backgroundColor": isDark ? "#0a0a0a" : "#ffffff",
                "gridColor": isDark ? "#1a1a1a" : "#e5e5e5"
            });
        }

        async function fetchAllData() {
            await Promise.all([fetchBTCPrice(), fetchGoldPrice()]);
            estimateBTCOptions();
            estimateGoldOptions();
            updateUI();
        }

        window.addEventListener('DOMContentLoaded', () => {
            const button = document.querySelector('.theme-toggle');
            if (currentTheme === 'day') {
                document.documentElement.setAttribute('data-theme', 'day');
                button.textContent = 'Night Mode';
            }
            fetchAllData();
            initChart();
            setInterval(fetchAllData, 60000);
        });
    </script>
</body>
</html>
