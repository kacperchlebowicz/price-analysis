<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metals to Crypto Flow Tracker</title>
    <meta http-equiv="refresh" content="300">
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #0a0a0a;
            --border: #1a1a1a;
            --text-primary: #e5e5e5;
            --text-secondary: #999;
            --text-tertiary: #666;
            --accent: #fff;
            --positive: #4a7c59;
            --negative: #7c4a4a;
            --neutral: #7c7c4a;
            --gold: #d4af37;
            --silver: #a8a8a8;
        }

        [data-theme="day"] {
            --bg-primary: #fafafa;
            --bg-secondary: #fff;
            --border: #e5e5e5;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --text-tertiary: #999;
            --accent: #000;
            --positive: #16a34a;
            --negative: #dc2626;
            --neutral: #ea580c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 40px 20px;
            line-height: 1.6;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .nav {
            display: flex;
            gap: 8px;
            padding: 12px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            margin: -40px -20px 40px -20px;
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85em;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .nav-link:hover {
            color: var(--text-primary);
            background: var(--bg-primary);
            border-color: var(--border);
        }

        .nav-link.active {
            color: var(--text-primary);
            background: var(--bg-primary);
            border-color: var(--border);
            font-weight: 500;
        }

        .header {
            margin-bottom: 60px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-content {
            flex: 1;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .theme-toggle, .refresh-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .theme-toggle:hover, .refresh-btn:hover {
            color: var(--text-primary);
            border-color: var(--text-tertiary);
        }

        h1 {
            font-size: 2.5em;
            font-weight: 300;
            margin-bottom: 10px;
            letter-spacing: -0.02em;
            color: var(--text-primary);
        }

        .subtitle {
            color: var(--text-tertiary);
            font-size: 0.95em;
        }

        .meta {
            color: var(--text-tertiary);
            font-size: 0.9em;
            margin-top: 10px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1px;
            background: var(--border);
            margin-bottom: 1px;
        }

        .card {
            background: var(--bg-secondary);
            padding: 30px;
            transition: background 0.3s ease;
        }

        .card-title {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-tertiary);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .card-timestamp {
            font-size: 0.7em;
            color: var(--text-tertiary);
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            text-align: right;
        }

        .price-large {
            font-size: 2em;
            font-weight: 200;
            margin-bottom: 10px;
            font-variant-numeric: tabular-nums;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .metric-value {
            font-variant-numeric: tabular-nums;
            color: var(--text-primary);
        }

        .positive { color: var(--positive); }
        .negative { color: var(--negative); }
        .neutral { color: var(--neutral); }

        .section {
            margin: 60px 0;
        }

        .section-title {
            font-size: 1.5em;
            font-weight: 300;
            margin-bottom: 30px;
            letter-spacing: -0.01em;
            color: var(--text-primary);
        }

        .flow-banner {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 30px;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .flow-banner.bullish {
            border-left: 3px solid var(--positive);
        }

        .flow-banner.bearish {
            border-left: 3px solid var(--negative);
        }

        .flow-icon {
            font-size: 2.5em;
            opacity: 0.8;
        }

        .flow-content {
            flex: 1;
        }

        .flow-title {
            font-size: 1.2em;
            font-weight: 400;
            margin-bottom: 5px;
        }

        .flow-description {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .flow-meter {
            text-align: right;
        }

        .flow-meter-value {
            font-size: 2em;
            font-weight: 200;
        }

        .flow-meter-label {
            font-size: 0.75em;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .ratio-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1px;
            background: var(--border);
            border: 1px solid var(--border);
        }

        .ratio-card {
            background: var(--bg-secondary);
            padding: 30px;
        }

        .ratio-value {
            font-size: 2.5em;
            font-weight: 200;
            margin-bottom: 10px;
        }

        .ratio-change {
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .ratio-explanation {
            font-size: 0.85em;
            color: var(--text-tertiary);
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .signals-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1px;
            background: var(--border);
            border: 1px solid var(--border);
        }

        .signal-section {
            background: var(--bg-secondary);
            padding: 30px;
        }

        .signal-title {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-tertiary);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .signal-list {
            list-style: none;
        }

        .signal-list li {
            padding: 8px 0;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .signal-list li:before {
            content: "—";
            margin-right: 10px;
            color: var(--text-tertiary);
        }

        .summary {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 40px;
            text-align: center;
        }

        .summary-title {
            font-size: 1.2em;
            font-weight: 300;
            margin-bottom: 30px;
            color: var(--text-primary);
        }

        .summary-verdict {
            font-size: 1.5em;
            font-weight: 400;
            margin-bottom: 15px;
        }

        .summary-detail {
            color: var(--text-secondary);
            font-size: 0.95em;
            max-width: 600px;
            margin: 0 auto 30px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 30px;
            padding-top: 30px;
            border-top: 1px solid var(--border);
        }

        .summary-item {
            padding: 15px;
        }

        .summary-label {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-tertiary);
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 1.1em;
        }

        .chart-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 0;
            margin-bottom: 1px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .ratio-grid {
                grid-template-columns: 1fr;
            }
            .signals-grid {
                grid-template-columns: 1fr;
            }
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            h1 {
                font-size: 2em;
            }
            .header {
                flex-direction: column;
                gap: 20px;
            }
            .controls {
                width: 100%;
                flex-direction: column;
            }
            .theme-toggle, .refresh-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="nav">
            <a href="index.html" class="nav-link">Bitcoin Analysis</a>
            <a href="metals-crypto-tracker.html" class="nav-link active">Metals → Crypto Flow</a>
        </nav>

        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <h1>Metals → Crypto Flow</h1>
                <div class="subtitle">Track capital rotation between Gold, Silver and Bitcoin</div>
                <div class="meta" id="lastUpdate">Connecting to markets...</div>
            </div>
            <div class="controls">
                <button class="refresh-btn" onclick="location.reload()">Refresh</button>
                <button class="theme-toggle" onclick="toggleTheme()">Day Mode</button>
            </div>
        </div>

        <!-- Flow Alert Banner -->
        <div class="flow-banner" id="flowBanner">
            <div class="flow-icon" id="flowIcon">⟷</div>
            <div class="flow-content">
                <div class="flow-title" id="flowTitle">Analyzing Market Flow...</div>
                <div class="flow-description" id="flowDescription">Loading price data to determine rotation signals</div>
            </div>
            <div class="flow-meter">
                <div class="flow-meter-value" id="flowStrength">--</div>
                <div class="flow-meter-label">Flow Strength</div>
            </div>
        </div>

        <!-- Price Cards -->
        <div class="grid">
            <div class="card">
                <div class="card-title">Gold (XAU/USD)</div>
                <div class="price-large" id="goldPrice">$---.--</div>
                <div class="metric-row">
                    <span class="metric-label">24h Change</span>
                    <span class="metric-value" id="goldChange24h">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">vs BTC (24h)</span>
                    <span class="metric-value" id="goldVsBtc">—</span>
                </div>
                <div class="card-timestamp" id="tsGold">—</div>
            </div>

            <div class="card">
                <div class="card-title">Silver (XAG/USD)</div>
                <div class="price-large" id="silverPrice">$--.--</div>
                <div class="metric-row">
                    <span class="metric-label">24h Change</span>
                    <span class="metric-value" id="silverChange24h">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">vs BTC (24h)</span>
                    <span class="metric-value" id="silverVsBtc">—</span>
                </div>
                <div class="card-timestamp" id="tsSilver">—</div>
            </div>

            <div class="card">
                <div class="card-title">Bitcoin (Futures)</div>
                <div class="price-large" id="btcPrice">$--,---.--</div>
                <div class="metric-row">
                    <span class="metric-label">24h Change</span>
                    <span class="metric-value" id="btcChange24h">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Funding Rate</span>
                    <span class="metric-value" id="btcFunding">—</span>
                </div>
                <div class="card-timestamp" id="tsBtc">—</div>
            </div>

            <div class="card">
                <div class="card-title">Ethereum (Futures)</div>
                <div class="price-large" id="ethPrice">$-,---.--</div>
                <div class="metric-row">
                    <span class="metric-label">24h Change</span>
                    <span class="metric-value" id="ethChange24h">—</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Funding Rate</span>
                    <span class="metric-value" id="ethFunding">—</span>
                </div>
                <div class="card-timestamp" id="tsEth">—</div>
            </div>
        </div>

        <!-- Key Ratios -->
        <div class="section">
            <div class="section-title">Rotation Ratios</div>
            <div class="ratio-grid">
                <div class="ratio-card">
                    <div class="card-title">Gold / Bitcoin Ratio</div>
                    <div class="ratio-value" id="goldBtcRatio">--</div>
                    <div class="ratio-change" id="goldBtcChange">Calculating...</div>
                    <div class="ratio-explanation">
                        Ounces of gold to buy 1 BTC. <strong>Falling = Money flowing to Bitcoin.</strong>
                    </div>
                </div>
                <div class="ratio-card">
                    <div class="card-title">Silver / Bitcoin Ratio</div>
                    <div class="ratio-value" id="silverBtcRatio">--</div>
                    <div class="ratio-change" id="silverBtcChange">Calculating...</div>
                    <div class="ratio-explanation">
                        Ounces of silver to buy 1 BTC. <strong>Falling = Money flowing to Bitcoin.</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- Flow Analysis -->
        <div class="section">
            <div class="section-title">Flow Analysis</div>
            <div class="grid">
                <div class="card">
                    <div class="card-title">24h Movement</div>
                    <div class="metric-row">
                        <span class="metric-label">Gold</span>
                        <span class="metric-value" id="flow24hGold">—</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Silver</span>
                        <span class="metric-value" id="flow24hSilver">—</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Bitcoin</span>
                        <span class="metric-value" id="flow24hBtc">—</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Metals Avg</span>
                        <span class="metric-value" id="flowMetalsAvg">—</span>
                    </div>
                    <div class="card-timestamp" id="tsFlow">—</div>
                </div>

                <div class="card">
                    <div class="card-title">Rotation Signals</div>
                    <div class="metric-row">
                        <span class="metric-label">Metals Trend</span>
                        <span class="metric-value" id="metalsTrend">—</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Crypto Trend</span>
                        <span class="metric-value" id="cryptoTrend">—</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Divergence</span>
                        <span class="metric-value" id="divergenceStatus">—</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Signal</span>
                        <span class="metric-value" id="rotationSignal">—</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Market Signals -->
        <div class="section">
            <div class="section-title">Market Signals</div>
            <div class="signals-grid">
                <div class="signal-section">
                    <div class="signal-title">Bullish Crypto</div>
                    <ul class="signal-list" id="bullishSignals">
                        <li>Loading signals...</li>
                    </ul>
                </div>
                <div class="signal-section">
                    <div class="signal-title">Bullish Metals</div>
                    <ul class="signal-list" id="bearishSignals">
                        <li>Loading signals...</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="section">
            <div class="section-title">Gold vs Bitcoin Chart</div>
            <div class="chart-container">
                <div id="tradingview_chart" style="height: 500px;"></div>
            </div>
        </div>

        <!-- Summary -->
        <div class="section">
            <div class="summary">
                <div class="summary-title">Current Assessment</div>
                <div class="summary-verdict" id="summaryVerdict">Analyzing...</div>
                <div class="summary-detail" id="summaryDetail">Loading market data...</div>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">Metals Outlook</div>
                        <div class="summary-value" id="metalsOutlook">—</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Crypto Outlook</div>
                        <div class="summary-value" id="cryptoOutlook">—</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Rotation Probability</div>
                        <div class="summary-value" id="rotationProb">—</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Conviction</div>
                        <div class="summary-value" id="conviction">—</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://s3.tradingview.com/tv.js"></script>
    <script>
        let currentTheme = localStorage.getItem('metals-theme') || 'night';

        // Global state
        let marketData = {
            gold: { price: 0, change24h: 0 },
            silver: { price: 0, change24h: 0 },
            btc: { price: 0, change24h: 0, funding: 0 },
            eth: { price: 0, change24h: 0, funding: 0 }
        };

        // Format currency
        function formatPrice(price, decimals = 2) {
            return '$' + parseFloat(price).toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        // Format percentage
        function formatPercent(value) {
            const sign = value >= 0 ? '+' : '';
            return sign + value.toFixed(2) + '%';
        }

        // Get CSS class for value
        function getChangeClass(value) {
            if (value > 0.5) return 'positive';
            if (value < -0.5) return 'negative';
            return 'neutral';
        }

        // Format timestamp
        function formatTimestamp() {
            return new Date().toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        function updateTimestamp(id) {
            const el = document.getElementById(id);
            if (el) el.textContent = 'Updated: ' + formatTimestamp();
        }

        function toggleTheme() {
            const html = document.documentElement;
            const button = document.querySelector('.theme-toggle');

            if (currentTheme === 'day') {
                html.removeAttribute('data-theme');
                button.textContent = 'Day Mode';
                currentTheme = 'night';
            } else {
                html.setAttribute('data-theme', 'day');
                button.textContent = 'Night Mode';
                currentTheme = 'day';
            }

            localStorage.setItem('metals-theme', currentTheme);
            initChart();
        }

        // Fetch BTC futures data from Binance
        async function fetchBtcFutures() {
            try {
                const [tickerRes, fundingRes] = await Promise.all([
                    fetch('https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=BTCUSDT'),
                    fetch('https://fapi.binance.com/fapi/v1/fundingRate?symbol=BTCUSDT&limit=1')
                ]);

                const ticker = await tickerRes.json();
                const funding = await fundingRes.json();

                marketData.btc.price = parseFloat(ticker.lastPrice);
                marketData.btc.change24h = parseFloat(ticker.priceChangePercent);
                marketData.btc.funding = funding[0] ? parseFloat(funding[0].fundingRate) * 100 : 0;

                updateBtcUI();
                updateTimestamp('tsBtc');
            } catch (error) {
                console.error('Failed to fetch BTC futures:', error);
            }
        }

        // Fetch ETH futures data from Binance
        async function fetchEthFutures() {
            try {
                const [tickerRes, fundingRes] = await Promise.all([
                    fetch('https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=ETHUSDT'),
                    fetch('https://fapi.binance.com/fapi/v1/fundingRate?symbol=ETHUSDT&limit=1')
                ]);

                const ticker = await tickerRes.json();
                const funding = await fundingRes.json();

                marketData.eth.price = parseFloat(ticker.lastPrice);
                marketData.eth.change24h = parseFloat(ticker.priceChangePercent);
                marketData.eth.funding = funding[0] ? parseFloat(funding[0].fundingRate) * 100 : 0;

                updateEthUI();
                updateTimestamp('tsEth');
            } catch (error) {
                console.error('Failed to fetch ETH futures:', error);
            }
        }

        // Fetch metals prices from multiple sources
        async function fetchMetalsPrices() {
            let goldFetched = false;
            let silverFetched = false;

            // Try primary source: Free forex API for XAU and XAG
            try {
                const response = await fetch('https://api.frankfurter.app/latest?from=XAU&to=USD');
                if (response.ok) {
                    const data = await response.json();
                    if (data.rates && data.rates.USD) {
                        // XAU is quoted as USD per troy ounce
                        marketData.gold.price = data.rates.USD;
                        goldFetched = true;
                    }
                }
            } catch (e) {
                console.log('Frankfurter API not available for gold');
            }

            // Fallback: Use PAXG from Binance for gold
            if (!goldFetched) {
                try {
                    const paxgRes = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=PAXGUSDT');
                    const paxg = await paxgRes.json();
                    marketData.gold.price = parseFloat(paxg.lastPrice) || 2800;
                    marketData.gold.change24h = parseFloat(paxg.priceChangePercent) || 0;
                    goldFetched = true;
                } catch (e) {
                    console.log('PAXG fallback failed');
                    marketData.gold.price = 2800;
                    marketData.gold.change24h = 0;
                }
            }

            // Try to get silver from free metals API
            try {
                // Using a public CORS-friendly metals endpoint
                const silverRes = await fetch('https://data-asg.goldprice.org/dbXRates/USD');
                if (silverRes.ok) {
                    const silverData = await silverRes.json();
                    if (silverData.items && silverData.items[0]) {
                        const item = silverData.items[0];
                        // goldprice.org returns xauPrice and xagPrice
                        if (item.xagPrice) {
                            marketData.silver.price = item.xagPrice;
                            marketData.silver.change24h = item.pcXag || 0;
                            silverFetched = true;
                        }
                        // Also update gold if available and more accurate
                        if (item.xauPrice && !goldFetched) {
                            marketData.gold.price = item.xauPrice;
                            marketData.gold.change24h = item.pcXau || 0;
                            goldFetched = true;
                        }
                    }
                }
            } catch (e) {
                console.log('GoldPrice API not available');
            }

            // Final fallback for silver: use current market estimate
            if (!silverFetched) {
                // Current gold/silver ratio is around 30:1 (as of 2026)
                const goldSilverRatio = 30;
                marketData.silver.price = marketData.gold.price / goldSilverRatio;
                marketData.silver.change24h = marketData.gold.change24h * 1.3;
            }

            updateMetalsUI();
            updateTimestamp('tsGold');
            updateTimestamp('tsSilver');
        }

        // Update BTC UI
        function updateBtcUI() {
            document.getElementById('btcPrice').textContent = formatPrice(marketData.btc.price);

            const changeEl = document.getElementById('btcChange24h');
            changeEl.textContent = formatPercent(marketData.btc.change24h);
            changeEl.className = 'metric-value ' + getChangeClass(marketData.btc.change24h);

            const fundingEl = document.getElementById('btcFunding');
            fundingEl.textContent = marketData.btc.funding.toFixed(4) + '%';
            fundingEl.className = 'metric-value ' + (marketData.btc.funding >= 0 ? 'positive' : 'negative');
        }

        // Update ETH UI
        function updateEthUI() {
            document.getElementById('ethPrice').textContent = formatPrice(marketData.eth.price);

            const changeEl = document.getElementById('ethChange24h');
            changeEl.textContent = formatPercent(marketData.eth.change24h);
            changeEl.className = 'metric-value ' + getChangeClass(marketData.eth.change24h);

            const fundingEl = document.getElementById('ethFunding');
            fundingEl.textContent = marketData.eth.funding.toFixed(4) + '%';
            fundingEl.className = 'metric-value ' + (marketData.eth.funding >= 0 ? 'positive' : 'negative');
        }

        // Update Metals UI
        function updateMetalsUI() {
            document.getElementById('goldPrice').textContent = formatPrice(marketData.gold.price);
            const goldChangeEl = document.getElementById('goldChange24h');
            goldChangeEl.textContent = formatPercent(marketData.gold.change24h);
            goldChangeEl.className = 'metric-value ' + getChangeClass(marketData.gold.change24h);

            document.getElementById('silverPrice').textContent = formatPrice(marketData.silver.price);
            const silverChangeEl = document.getElementById('silverChange24h');
            silverChangeEl.textContent = formatPercent(marketData.silver.change24h);
            silverChangeEl.className = 'metric-value ' + getChangeClass(marketData.silver.change24h);

            // Relative performance vs BTC
            const goldVsBtc = marketData.gold.change24h - marketData.btc.change24h;
            const goldVsBtcEl = document.getElementById('goldVsBtc');
            goldVsBtcEl.textContent = formatPercent(goldVsBtc);
            goldVsBtcEl.className = 'metric-value ' + getChangeClass(goldVsBtc);

            const silverVsBtc = marketData.silver.change24h - marketData.btc.change24h;
            const silverVsBtcEl = document.getElementById('silverVsBtc');
            silverVsBtcEl.textContent = formatPercent(silverVsBtc);
            silverVsBtcEl.className = 'metric-value ' + getChangeClass(silverVsBtc);
        }

        // Update ratios
        function updateRatios() {
            if (marketData.btc.price === 0 || marketData.gold.price === 0) return;

            const goldBtcRatio = marketData.btc.price / marketData.gold.price;
            document.getElementById('goldBtcRatio').textContent = goldBtcRatio.toFixed(2) + ' oz';

            const silverBtcRatio = marketData.btc.price / marketData.silver.price;
            document.getElementById('silverBtcRatio').textContent = Math.round(silverBtcRatio) + ' oz';

            // Ratio change based on relative performance
            const goldRatioChange = marketData.btc.change24h - marketData.gold.change24h;
            const goldChangeEl = document.getElementById('goldBtcChange');
            if (goldRatioChange > 0) {
                goldChangeEl.innerHTML = `<span class="positive">Ratio Rising (${formatPercent(goldRatioChange)}) - BTC gaining</span>`;
            } else {
                goldChangeEl.innerHTML = `<span class="negative">Ratio Falling (${formatPercent(goldRatioChange)}) - Gold gaining</span>`;
            }

            const silverRatioChange = marketData.btc.change24h - marketData.silver.change24h;
            const silverChangeEl = document.getElementById('silverBtcChange');
            if (silverRatioChange > 0) {
                silverChangeEl.innerHTML = `<span class="positive">Ratio Rising (${formatPercent(silverRatioChange)}) - BTC gaining</span>`;
            } else {
                silverChangeEl.innerHTML = `<span class="negative">Ratio Falling (${formatPercent(silverRatioChange)}) - Silver gaining</span>`;
            }
        }

        // Update flow analysis
        function updateFlowAnalysis() {
            const metalsAvg = (marketData.gold.change24h + marketData.silver.change24h) / 2;
            const cryptoAvg = (marketData.btc.change24h + marketData.eth.change24h) / 2;
            const flowDiff = cryptoAvg - metalsAvg;

            // 24h movements
            const flow24hGoldEl = document.getElementById('flow24hGold');
            flow24hGoldEl.textContent = formatPercent(marketData.gold.change24h);
            flow24hGoldEl.className = 'metric-value ' + getChangeClass(marketData.gold.change24h);

            const flow24hSilverEl = document.getElementById('flow24hSilver');
            flow24hSilverEl.textContent = formatPercent(marketData.silver.change24h);
            flow24hSilverEl.className = 'metric-value ' + getChangeClass(marketData.silver.change24h);

            const flow24hBtcEl = document.getElementById('flow24hBtc');
            flow24hBtcEl.textContent = formatPercent(marketData.btc.change24h);
            flow24hBtcEl.className = 'metric-value ' + getChangeClass(marketData.btc.change24h);

            const flowMetalsAvgEl = document.getElementById('flowMetalsAvg');
            flowMetalsAvgEl.textContent = formatPercent(metalsAvg);
            flowMetalsAvgEl.className = 'metric-value ' + getChangeClass(metalsAvg);

            updateTimestamp('tsFlow');

            // Trend analysis
            const metalsTrendEl = document.getElementById('metalsTrend');
            if (metalsAvg > 1) {
                metalsTrendEl.textContent = 'Bullish';
                metalsTrendEl.className = 'metric-value positive';
            } else if (metalsAvg < -1) {
                metalsTrendEl.textContent = 'Bearish';
                metalsTrendEl.className = 'metric-value negative';
            } else {
                metalsTrendEl.textContent = 'Neutral';
                metalsTrendEl.className = 'metric-value neutral';
            }

            const cryptoTrendEl = document.getElementById('cryptoTrend');
            if (cryptoAvg > 2) {
                cryptoTrendEl.textContent = 'Bullish';
                cryptoTrendEl.className = 'metric-value positive';
            } else if (cryptoAvg < -2) {
                cryptoTrendEl.textContent = 'Bearish';
                cryptoTrendEl.className = 'metric-value negative';
            } else {
                cryptoTrendEl.textContent = 'Neutral';
                cryptoTrendEl.className = 'metric-value neutral';
            }

            // Divergence
            const divergenceEl = document.getElementById('divergenceStatus');
            const rotationEl = document.getElementById('rotationSignal');

            if (metalsAvg < -0.5 && cryptoAvg > 1) {
                divergenceEl.textContent = 'Diverging';
                divergenceEl.className = 'metric-value positive';
                rotationEl.textContent = 'Crypto Rotation';
                rotationEl.className = 'metric-value positive';
            } else if (metalsAvg > 0.5 && cryptoAvg < -1) {
                divergenceEl.textContent = 'Diverging';
                divergenceEl.className = 'metric-value negative';
                rotationEl.textContent = 'Metals Rotation';
                rotationEl.className = 'metric-value negative';
            } else if (Math.abs(flowDiff) > 3) {
                divergenceEl.textContent = 'Spread Wide';
                divergenceEl.className = 'metric-value neutral';
                rotationEl.textContent = flowDiff > 0 ? 'Crypto Leading' : 'Metals Leading';
                rotationEl.className = 'metric-value neutral';
            } else {
                divergenceEl.textContent = 'None';
                divergenceEl.className = 'metric-value';
                rotationEl.textContent = 'No Signal';
                rotationEl.className = 'metric-value';
            }

            updateFlowBanner(metalsAvg, cryptoAvg, flowDiff);
            updateSignals(metalsAvg, cryptoAvg, flowDiff);
            updateSummary(metalsAvg, cryptoAvg, flowDiff);
        }

        // Update flow banner
        function updateFlowBanner(metalsAvg, cryptoAvg, flowDiff) {
            const banner = document.getElementById('flowBanner');
            const icon = document.getElementById('flowIcon');
            const title = document.getElementById('flowTitle');
            const desc = document.getElementById('flowDescription');
            const strength = document.getElementById('flowStrength');

            banner.classList.remove('bullish', 'bearish');

            if (metalsAvg < -0.5 && cryptoAvg > 1) {
                banner.classList.add('bullish');
                icon.textContent = '→';
                title.textContent = 'Capital Rotating to Crypto';
                desc.textContent = `Metals declining (${metalsAvg.toFixed(1)}%) while crypto rises (${cryptoAvg.toFixed(1)}%). Risk-on signal.`;
                strength.textContent = Math.min(Math.abs(flowDiff) * 10, 100).toFixed(0) + '%';
                strength.className = 'flow-meter-value positive';
            } else if (metalsAvg > 0.5 && cryptoAvg < -1) {
                banner.classList.add('bearish');
                icon.textContent = '←';
                title.textContent = 'Capital Rotating to Metals';
                desc.textContent = `Crypto declining (${cryptoAvg.toFixed(1)}%) while metals rise (${metalsAvg.toFixed(1)}%). Risk-off signal.`;
                strength.textContent = Math.min(Math.abs(flowDiff) * 10, 100).toFixed(0) + '%';
                strength.className = 'flow-meter-value negative';
            } else if (flowDiff > 3) {
                icon.textContent = '↗';
                title.textContent = 'Crypto Outperforming';
                desc.textContent = `Bitcoin leading metals by ${flowDiff.toFixed(1)}% spread. Monitor for continuation.`;
                strength.textContent = Math.min(flowDiff * 15, 100).toFixed(0) + '%';
                strength.className = 'flow-meter-value neutral';
            } else if (flowDiff < -3) {
                icon.textContent = '↙';
                title.textContent = 'Metals Outperforming';
                desc.textContent = `Gold/Silver leading crypto by ${Math.abs(flowDiff).toFixed(1)}% spread.`;
                strength.textContent = Math.min(Math.abs(flowDiff) * 15, 100).toFixed(0) + '%';
                strength.className = 'flow-meter-value neutral';
            } else {
                icon.textContent = '⟷';
                title.textContent = 'No Clear Rotation';
                desc.textContent = 'Markets moving together. No significant capital rotation detected.';
                strength.textContent = 'Low';
                strength.className = 'flow-meter-value';
            }
        }

        // Update signals
        function updateSignals(metalsAvg, cryptoAvg, flowDiff) {
            const bullishSignals = [];
            const bearishSignals = [];

            // Crypto bullish signals
            if (marketData.btc.change24h > 2) bullishSignals.push('Strong BTC momentum (' + formatPercent(marketData.btc.change24h) + ')');
            if (marketData.btc.funding > 0 && marketData.btc.funding < 0.05) bullishSignals.push('Healthy funding rate');
            if (metalsAvg < 0 && cryptoAvg > 0) bullishSignals.push('Inverse correlation active');
            if (flowDiff > 3) bullishSignals.push('Crypto outperforming by ' + flowDiff.toFixed(1) + '%');
            if (marketData.eth.change24h > 3) bullishSignals.push('ETH showing strength');

            // Metals bullish signals
            if (marketData.gold.change24h > 1) bearishSignals.push('Gold rallying (' + formatPercent(marketData.gold.change24h) + ')');
            if (marketData.silver.change24h > 1.5) bearishSignals.push('Silver showing strength');
            if (cryptoAvg < -2) bearishSignals.push('Crypto weakness detected');
            if (metalsAvg > 0 && cryptoAvg < 0) bearishSignals.push('Risk-off rotation active');
            if (marketData.btc.funding > 0.1) bearishSignals.push('Funding rate overheated');

            // Default messages
            if (bullishSignals.length === 0) bullishSignals.push('No strong bullish signals');
            if (bearishSignals.length === 0) bearishSignals.push('No strong bearish signals');

            document.getElementById('bullishSignals').innerHTML = bullishSignals.map(s => `<li>${s}</li>`).join('');
            document.getElementById('bearishSignals').innerHTML = bearishSignals.map(s => `<li>${s}</li>`).join('');
        }

        // Update summary
        function updateSummary(metalsAvg, cryptoAvg, flowDiff) {
            let rotationProb = 50;

            if (metalsAvg < 0 && cryptoAvg > 0) rotationProb += 20;
            if (metalsAvg < -1 && cryptoAvg > 2) rotationProb += 15;
            if (Math.abs(flowDiff) > 3) rotationProb += 10;
            if (marketData.btc.funding > 0 && marketData.btc.funding < 0.05) rotationProb += 5;

            rotationProb = Math.min(95, Math.max(5, rotationProb));

            const verdictEl = document.getElementById('summaryVerdict');
            const detailEl = document.getElementById('summaryDetail');

            if (rotationProb > 70) {
                verdictEl.textContent = 'High Probability: Crypto Rotation';
                verdictEl.className = 'summary-verdict positive';
                detailEl.textContent = 'Multiple indicators suggest capital flowing from metals to crypto. Risk appetite appears elevated.';
            } else if (rotationProb < 30) {
                verdictEl.textContent = 'Low Probability: Favor Metals';
                verdictEl.className = 'summary-verdict negative';
                detailEl.textContent = 'Safe-haven assets showing strength. Consider defensive positioning.';
            } else {
                verdictEl.textContent = 'Neutral: Monitor for Signals';
                verdictEl.className = 'summary-verdict neutral';
                detailEl.textContent = 'Mixed signals. Wait for clearer divergence before making rotation decisions.';
            }

            document.getElementById('metalsOutlook').textContent = metalsAvg > 1 ? 'Bullish' : metalsAvg < -1 ? 'Bearish' : 'Neutral';
            document.getElementById('metalsOutlook').className = 'summary-value ' + getChangeClass(metalsAvg);

            document.getElementById('cryptoOutlook').textContent = cryptoAvg > 2 ? 'Bullish' : cryptoAvg < -2 ? 'Bearish' : 'Neutral';
            document.getElementById('cryptoOutlook').className = 'summary-value ' + getChangeClass(cryptoAvg);

            document.getElementById('rotationProb').textContent = rotationProb + '%';
            document.getElementById('rotationProb').className = 'summary-value ' + (rotationProb > 60 ? 'positive' : rotationProb < 40 ? 'negative' : 'neutral');

            const conviction = Math.abs(flowDiff) > 5 ? 'High' : Math.abs(flowDiff) > 2 ? 'Medium' : 'Low';
            document.getElementById('conviction').textContent = conviction;
            document.getElementById('conviction').className = 'summary-value ' + (conviction === 'High' ? 'positive' : conviction === 'Low' ? 'negative' : 'neutral');
        }

        // Initialize TradingView chart
        function initChart() {
            const container = document.getElementById('tradingview_chart');
            if (!container) return;

            container.innerHTML = '';

            const isDark = currentTheme === 'night';

            new TradingView.widget({
                "autosize": true,
                "symbol": "TVC:GOLD",
                "interval": "240",
                "timezone": "Etc/UTC",
                "theme": isDark ? "dark" : "light",
                "style": "1",
                "locale": "en",
                "toolbar_bg": isDark ? "#0a0a0a" : "#fafafa",
                "enable_publishing": false,
                "hide_side_toolbar": false,
                "allow_symbol_change": true,
                "container_id": "tradingview_chart",
                "compare_symbol": [{"symbol": "BINANCE:BTCUSDT", "position": "SameScale"}],
                "hide_top_toolbar": false,
                "save_image": false,
                "backgroundColor": isDark ? "#0a0a0a" : "#ffffff",
                "gridColor": isDark ? "#1a1a1a" : "#e5e5e5"
            });
        }

        // Fetch all data
        async function fetchAllData() {
            await Promise.all([
                fetchBtcFutures(),
                fetchEthFutures(),
                fetchMetalsPrices()
            ]);

            updateRatios();
            updateFlowAnalysis();

            const now = new Date();
            document.getElementById('lastUpdate').textContent =
                'Last update: ' + now.toISOString().replace('T', ' ').substring(0, 19) + ' UTC • Auto-refresh: 30s';
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            const button = document.querySelector('.theme-toggle');
            if (currentTheme === 'day') {
                document.documentElement.setAttribute('data-theme', 'day');
                button.textContent = 'Night Mode';
            }

            fetchAllData();
            initChart();

            // Refresh every 30 seconds
            setInterval(fetchAllData, 30000);
        });
    </script>
</body>
</html>
